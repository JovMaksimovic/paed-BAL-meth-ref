---
title: "Methylation profiling of paediatric Bronchoalveolar Lavage (BAL)"
subtitle: "Estimating cell type proportions of raw paediatric BAL"
author: "Jovana Maksimovic"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data import

Load all necessary analysis packages.

```{r, message=FALSE}
library(here)
library(workflowr)
library(glue)
#Load Packages Required for Analysis
library(limma)
library(minfi)
library(matrixStats)
library(IlluminaHumanMethylationEPICanno.ilm10b4.hg19)
library(IlluminaHumanMethylationEPICmanifest)
library(FlowSorted.Blood.EPIC)
library(ggplot2)
library(ExperimentHub)
library(reshape2)
library(tidyverse)
library(patchwork)
library(missMethyl)
library(cowplot)
```

Load raw and processed data objects generated by exploratory analysis.

```{r}
# load data objects
load(here("data/processedData.RData"))
# load modified cell type estimation function
source(here("code/functions.R"))
```

As expected, we see clear clustering by cell types.

```{r}
mds <- plotMDS(mVals[, cells], top = 1000, gene.selection="common", plot = FALSE)
dat <- tibble(x = mds$x, 
              y = mds$y, 
              sample = targets$Sample_Group[cells], 
              run = targets$Sample_run[cells],
              ID = targets$Sample_ID[cells])

p <- ggplot(dat, aes(x = x, y = y, colour = sample)) +
  geom_point(aes(shape = run), size = 3) +
  labs(colour = "Sample type", shape = "Run",
       x = "Principal component 1", 
       y = "Principal component 2") +
  ggtitle("Cell types") +
  scale_color_manual(values = pal[-2])
p
```

# Identify cell type discriminating probes

Identify cell type discriminating probesusing the *any* and  *both* method (*both* selects an equal number (50) of probes (with F-stat p-value < 1E-8) with the greatest magnitude of effect from the hyper and hypo methylated sides; or *any*, which selects the 100 probes (with F-stat p-value < 1E-8) with the greatest magnitude of difference regardless of direction of effect.).

```{r}
mSetSqFlt$CellType <- as.character(targets$Sample_Group)

pAny <- minfi:::pickCompProbes(mSet = mSetSqFlt[rownames(mSetSqFlt) %in% rownames(mValsNoXY),
                                                cells], probeSelect = "any",
                       numProbes = 50, compositeCellType = "Lavage", 
                       cellTypes = unique(targets$Sample_Group[cells]))
pBoth <- minfi:::pickCompProbes(mSet = mSetSqFlt[rownames(mSetSqFlt) %in% rownames(mValsNoXY),
                                                 cells], probeSelect = "both",
                       numProbes = 50, compositeCellType = "Lavage", 
                       cellTypes = unique(targets$Sample_Group[cells]))
```

## Compare different selection methods

Use a heatmap to visulalise the methylation of the cell type discriminating probes in the cell sorted samples.

### **Figure 3**

```{r, fig.width=10}
par(mfrow=c(1,2))
NMF::aheatmap(bVals[rownames(bVals) %in% rownames(pAny$coefEsts), cells],
         annCol = list(CellType = as.character(targets$Sample_Group[cells])), 
         labCol = NA, labRow = NA, annColors = list(pal[-2]),
         main="A. Probe select = 'Any'")

NMF::aheatmap(bVals[rownames(bVals) %in% rownames(pBoth$coefEsts), cells],
         annCol = list(CellType = as.character(targets$Sample_Group[cells])), 
         labCol = NA, labRow = NA, annColors = list(pal[-2]),
         main="B. Probe select = 'Both'")
```
## Characteristics of probes selected using *"any"*

```{r}
ann <- getAnnotation(IlluminaHumanMethylationEPICanno.ilm10b4.hg19)
sub <- targets[targets$Sample_Group != "Raw",]
tmp <- mValsNoXY[rownames(mValsNoXY) %in% rownames(pAny$coefEsts), 
                 colnames(mValsNoXY) %in% sub$Sample_ID]
tmpAny <- ann[match(rownames(tmp), ann$Name), -c(5:17,20,21,23,32:37)]

topAnyFile <- here("output",
                   glue("GO-Any.csv"))

if(!file.exists(topAnyFile)){
  gstAny <- gometh(sig.cpg = rownames(pAny$coefEsts), 
                   all.cpg = rownames(mValsNoXY), 
                   anno = ann)
  topAny <- topGSA(gstAny, number = 50)
  write.csv(topAny, topAnyFile)
  
} else {
  topAny <- read.csv(topAnyFile, row.names = 1)
  
}

topAny %>% knitr::kable()
```

```{r, fig.asp=1}
flatAnn <- missMethyl:::.getFlatAnnotation("EPIC")
dat <- tmpAny
dat %>% data.frame %>%
  left_join(flatAnn, by = c("Name" = "cpg")) -> dat

dat %>%
ggplot(aes(x = Relation_to_Island, 
           fill = Relation_to_Island)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = "Relation_to_Island", y = "% Features") +
  theme_cowplot(font_size = 12) -> p1

dat %>%
  mutate(Gene = UCSC_RefGene_Name != "") %>%
  ggplot(aes(x = Gene, 
           fill = Gene)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = "Gene_associated", y = "% Features") +
  theme_cowplot(font_size = 12) -> p2

dat %>%
  mutate(group = ifelse(is.na(group), "Intergenic", group)) %>%
  ggplot(aes(x = group, 
           fill = group)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = "Position_in_Gene", y = "% Features") +
  theme_cowplot(font_size = 12) -> p3

dat %>%
  mutate(DHS = DNase_Hypersensitivity_NAME != "") %>%
  ggplot(aes(x = DHS, 
           fill = DHS)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = "DNase_Hypersensitivity_Site", y = "% Features") +
  theme_cowplot(font_size = 12) -> p4

((p1 | p2 ) /
  (p3 | p4)) & 
  theme(legend.position = "none",
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 8),
        axis.text = element_text(size = 6)) -> anyLoci
anyLoci
```

## Characteristics of probes selected using *"both"*

```{r}
sub <- targets[targets$Sample_Group != "Raw",]
tmp <- mValsNoXY[rownames(mValsNoXY) %in% rownames(pBoth$coefEsts), 
                 colnames(mValsNoXY) %in% sub$Sample_ID]
tmpBoth <- ann[match(rownames(tmp), ann$Name), -c(5:17,20,21,23,32:37)]

topBothFile <- here("output",
                   glue("GO-Both.csv"))

if(!file.exists(topBothFile)){
  gstBoth <- gometh(sig.cpg = rownames(pBoth$coefEsts), 
                   all.cpg = rownames(mValsNoXY), 
                   anno = ann)
  topBoth <- topGSA(gstBoth, number = 50)
  write.csv(topBoth, topBothFile)
  
} else {
  topBoth <- read.csv(topBothFile, row.names = 1)
  
}

topGSA(topBoth) %>% knitr::kable()
```

```{r, fig.asp=1}
dat <- tmpBoth
dat %>% data.frame %>%
  left_join(flatAnn, by = c("Name" = "cpg")) -> dat

dat %>%
ggplot(aes(x = Relation_to_Island, 
           fill = Relation_to_Island)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = "Relation_to_Island", y = "% Features") +
  theme_cowplot(font_size = 12) -> p1

dat %>%
  mutate(Gene = UCSC_RefGene_Name != "") %>%
  ggplot(aes(x = Gene, 
           fill = Gene)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = "Gene_associated", y = "% Features") +
  theme_cowplot(font_size = 12) -> p2

dat %>%
  mutate(group = ifelse(is.na(group), "Intergenic", group)) %>%
  ggplot(aes(x = group, 
           fill = group)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = "Position_in_Gene", y = "% Features") +
  theme_cowplot(font_size = 12) -> p3

dat %>%
  mutate(DHS = DNase_Hypersensitivity_NAME != "") %>%
  ggplot(aes(x = DHS, 
           fill = DHS)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = "DNase_Hypersensitivity_Site", y = "% Features") +
  theme_cowplot(font_size = 12) -> p4

((p1 | p2 ) /
  (p3 | p4)) & 
  theme(legend.position = "none",
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 8),
        axis.text = element_text(size = 6)) -> bothLoci
bothLoci
```

### **Supplementary Figure 3**

```{r, fig.asp=2}
(wrap_elements(anyLoci + plot_annotation(title = "Probe select = 'Any'"))  / 
   wrap_elements(bothLoci + plot_annotation(title = "Probe select = 'Both'"))) + plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(face = 'bold', size = 16))
```

## Characteristics of probes that are the same for *"any"* and *"both"*

```{r, fig.asp=1}
same <- intersect(rownames(pAny$coefEsts), rownames(pBoth$coefEsts))
length(same)
```

The number of probes that is the same using *any* and *both* is `r length(same)`. This 
is `r round(length(same)/length(rownames(pAny$coefEsts))*100,2)`% of the total 
number of cell type discriminating probes.

```{r}
tmp <- mValsNoXY[rownames(mValsNoXY) %in% same,
                 colnames(mValsNoXY) %in% sub$Sample_ID]
tmpSame <- ann[match(rownames(tmp), ann$Name), -c(5:17,20,21,23,32:37)]

topSameFile <- here("output/GO-Same.csv")

if(!file.exists(topSameFile)){
  gstSame <- gometh(sig.cpg = same, 
                   all.cpg = rownames(mValsNoXY), 
                   anno = ann)
  topSame <- topGSA(gstSame, number = 50)
  write.csv(topSame, topSameFile)
  
} else {
  topSame <- read.csv(topSameFile, row.names = 1)
  
}


topGSA(topSame) %>% knitr::kable()
```

## Characteristics of probes that are different between *"any"* and *"both"*

```{r, fig.asp=1}
diff <- c(rownames(pAny$coefEsts)[!rownames(pAny$coefEsts) %in% same],
          rownames(pBoth$coefEsts)[!rownames(pBoth$coefEsts) %in% same])
length(diff)
```

The number of probes that is different using *any* and *both* is `r length(diff)`. This 
is `r round(length(diff)/length(rownames(pAny$coefEsts))*100,2)`% of the total 
number of cell type discriminating probes.

```{r}
tmp <- mValsNoXY[rownames(mValsNoXY) %in% diff,
                 colnames(mValsNoXY) %in% sub$Sample_ID]
tmpDiff <- ann[match(rownames(tmp), ann$Name), -c(5:17,20,21,23,32:37)]

topDiffFile <- here("output/GO-Diff.csv")

if(!file.exists(topDiffFile)){
  gstDiff <- gometh(sig.cpg = diff, 
                   all.cpg = rownames(mValsNoXY), 
                   anno = ann)
  topDiff <- topGSA(gstDiff, number = 50)
  write.csv(topDiff, topDiffFile)
  
} else {
  topDiff <- read.csv(topDiffFile, row.names = 1)
  
}


topGSA(topDiff) %>% knitr::kable()
```

# Estimate cell type proportions of raw BAL samples

## Artificial mixture

We will use blood immune cell mixtures with known cell type proportions published by Salas et al. 2018 to test the accuracy of cell type proportion estimates derived using our reference library.  

```{r}
hub <- ExperimentHub()  
query(hub, "FlowSorted.Blood.EPIC") 
FlowSorted.Blood.EPIC <- hub[["EH1136"]]

# separate the reference from the testing dataset  
RGsetTargets <- FlowSorted.Blood.EPIC[,FlowSorted.Blood.EPIC$CellType == "MIX"]
mixReal <- as.matrix(colData(RGsetTargets)[,12:17])/100
```

```{r}
mixDat <- melt(mixReal)
colnames(mixDat) <- c("sample","cell","proportion")

p <- ggplot(mixDat, aes(sample)) + 
  geom_bar(aes(fill = cell, weight=proportion)) +
  scale_x_discrete(breaks = waiver(), labels=1:nrow(mixReal)) +
  ggtitle("Artificially created cell mixtures") +
  labs(y = "Proportion", x = "Mixture", fill = "Cell type")
p
```

We have not sorted our BAL lymphocytes into B cells, T cells and NK cells, so the "true" 
lymphocyte value we will compare to is the sum of the proportions of those cells in the 
artificial mixture.

```{r}
mixSum <- data.frame(mixReal[,5:6], Lymph = rowSums(mixReal[,1:4]))
mixSumDat <- melt(as.matrix(mixSum))
colnames(mixSumDat) <- c("sample","cell","proportion")

p <- ggplot(mixSumDat, aes(sample)) + 
  geom_bar(aes(fill = cell, weight = proportion)) +
    scale_x_discrete(breaks = waiver(), labels = 1:nrow(mixReal)) +
    ggtitle("Artificially created cell mixtures") +
  labs(y = "Proportion", x = "Mixture", fill = "Cell type")
p
```

Estimate cell type proportions in artificial mixture using *both* option.

```{r}
lavageRef <- rgSet[,cells]
colData(lavageRef)$CellType <- colData(lavageRef)$Sample_Group
mixEstBoth <- estimateCellCounts2Mod(rgSet = RGsetTargets,
                                  compositeCellType = "Lavage",
                                  processMethod = "preprocessQuantile",
                                  probeSelect = "both",
                                  cellTypes = unique(targets$Sample_Group[cells]),
                                  referencePlatform =
                                    "IlluminaHumanMethylationEPIC",
                                  referenceset = "lavageRef",
                                  IDOLOptimizedCpGs = NULL,
                                  returnAll = FALSE,
                                  meanPlot = FALSE,
                                  keepProbes = rownames(mValsNoXY))
mixEstBoth$counts
```

```{r}
mixBoth <- reshape2::melt(mixEstBoth$counts)
colnames(mixBoth) <- c("sample","cell","proportion")

p1 <- ggplot(mixBoth, aes(x = sample, fill = cell)) + 
  geom_bar(aes(weight = proportion)) +
  ggtitle("Cell type proportion estimates", 
          subtitle = "Probe selection: Both") +
  labs(x = "Sample", y = "Proportion", fill = "Cell type") + 
  scale_x_discrete(breaks = waiver(), labels = 1:nrow(mixReal)) +
  scale_fill_manual(values = pal)
p1
```
```{r}
(p | p1) + 
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom",
        legend.box = "vertical")
```

Estimate cell type proportions in artificial mixture using *"any"* option.

```{r}
mixEstAny <- estimateCellCounts2Mod(rgSet = RGsetTargets, 
                                 compositeCellType = "Lavage",   
                                processMethod = "preprocessQuantile",  
                                probeSelect = "any",  
                                cellTypes = unique(targets$Sample_Group[cells]),  
                                referencePlatform =   
                                "IlluminaHumanMethylationEPIC",  
                                referenceset = "lavageRef",  
                                IDOLOptimizedCpGs = NULL,   
                                returnAll = FALSE,
                                meanPlot = FALSE,
                                keepProbes = rownames(mValsNoXY))
mixEstAny$counts
```

```{r}
mixAny <- reshape2::melt(mixEstAny$counts)
colnames(mixAny) <- c("sample","cell","proportion")

p2 <- ggplot(mixAny, aes(x = sample, fill = cell)) + 
  geom_bar(aes(weight = proportion)) +
  ggtitle("Cell type proportion estimates", 
          subtitle = "Probe selection: Any") +
  labs(x = "Sample", y = "Proportion", fill = "Cell type") + 
  scale_x_discrete(breaks = waiver(), labels = 1:nrow(mixReal)) +
  scale_fill_manual(values = pal)
p2
```

```{r}
(p | p2) + 
  plot_layout(guides = "collect") & 
  theme(legend.position = "bottom",
        legend.box = "vertical")
```

```{r}
mixSumDat$est <- "Truth"
mixSumDat$num <- rownames(mixSumDat)
mixBoth$est <- "Est. (both)"
mixBoth$num <- rownames(mixBoth)
mixAny$est <- "Est. (any)"
mixAny$num <- rownames(mixAny)

fullDat <- rbind(mixSumDat, mixBoth, mixAny)
fullDat$cell <- fct_recode(fullDat$cell, 
                           Lymphocyte = "Lymph", 
                           Granulocyte = "Neu", 
                           Macrophage = "Mono")
fullDat <- fullDat[fullDat$cell != "EpithelialCell",]
fullDat$cell <- fct_drop(fullDat$cell)

p1a <- ggplot(fullDat, aes(x = sample, y = proportion, fill = est)) + 
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(.~ cell, scales = "free_x") +
  labs(x = "Mixture", y = "Proportion", fill = "Source") + 
  scale_x_discrete(breaks = waiver(), labels = 1:nrow(mixReal)) +
  theme_cowplot() +
  theme(axis.text.x = element_text(size = 8)) 

p1a
```

We can see that the estimates of granulocyte and lymphocute proportions made using our BAL reference panel are highly correlated with the true proportions regardless of how the discrimination probe set is chosen. Although there is evidence of slight overestimation of granulocytes in some samples. This  discrepancy is likely due to the fact that the mixture samples contain only neutrophils whereas our reference panel contains all granulocyte types. However, despite this shortcoming, the cell type proportion estimates are still very accurate. This suggests that our BAL reference panel, in combination with the Houseman algorithm, should be able to accurately estimate cell type proportions in our patient BAL samples. 

```{r, fig.width=7, fig.height=8}
dat1 <- tibble(x = rowMeans(cbind(mixSum[,"Neu"], 
                                 mixEstAny$counts[,"Granulocyte"])),
              y = (mixSum[,"Neu"] - mixEstAny$counts[,"Granulocyte"])) %>%
  mutate(Mixture = factor(1:n()))
c1 <- cor.test(mixSum[,'Neu'], mixEstAny$counts[,'Granulocyte'])
mse1 <- signif(mean(dat1$y^2), 2)
p1 <- ggplot(dat1, aes(x = x, y = y)) +
  geom_text(label = 1:nrow(mixSum), size = 2.5) +
  #geom_point(aes(color = Mixture)) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "red") +
  labs(x = "Mean", y = "Difference (Truth - Estimate)") +
  coord_cartesian(ylim = c(-0.2, 0.2)) +
  ggtitle("Granulocytes", subtitle = "Probe select = 'Any'") +
  theme_cowplot(font_size = 10) +
  annotate("text", x = 0.1, y = 0.2, hjust = 0, size = 3,
           label = glue::glue("MSE = {mse1}"))
           #label = glue::glue("Pearson correlation = {round(c1$estimate, 4)}
           #                   p-value = {signif(c1$p.value, 4)}"))

dat2 <- tibble(x = rowMeans(cbind(mixSum[,"Lymph"], 
                                 mixEstAny$counts[,"Lymphocyte"])),
              y = (mixSum[,"Lymph"] - mixEstAny$counts[,"Lymphocyte"])) %>%
  mutate(Mixture = factor(1:n()))
c2 <- cor.test(mixSum[,'Lymph'], mixEstAny$counts[,'Lymphocyte'])
mse2 <- signif(mean(dat2$y^2), 2)
p2 <- ggplot(dat2, aes(x = x, y = y)) +
  geom_text(label = 1:nrow(mixSum), size = 2.5) +
  #geom_point(aes(color = Mixture)) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "red") +
  labs(x = "Mean", y = "Difference (Truth - Estimate)") +
  coord_cartesian(ylim = c(-0.2, 0.2)) +
  ggtitle("Lymphocytes", subtitle = "Probe select = 'Any'") +
  theme_cowplot(font_size = 10) +
  annotate("text", x = 0.1, y = 0.2, hjust = 0, size = 3,
           label = glue::glue("MSE = {mse2}"))
           #label = glue::glue("Pearson correlation = {round(c2$estimate, 4)}
            #                   p-value = {signif(c2$p.value, 4)}"))

dat3 <- tibble(x = rowMeans(cbind(mixSum[,"Neu"], 
                                 mixEstBoth$counts[,"Granulocyte"])),
              y = (mixSum[,"Neu"] - mixEstBoth$counts[,"Granulocyte"])) %>%
  mutate(Mixture = factor(1:n()))
c3 <- cor.test(mixSum[,'Neu'], mixEstBoth$counts[,'Granulocyte'])
mse3 <- signif(mean(dat3$y^2), 2)
p3 <- ggplot(dat3, aes(x = x, y = y)) +
  geom_text(label = 1:nrow(mixSum), size = 2.5) +
  #geom_point(aes(color = Mixture)) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "red") +
  labs(x = "Mean", y = "Difference (Truth - Estimate)") +
  coord_cartesian(ylim = c(-0.2, 0.2)) +
  ggtitle("Granulocytes", subtitle = "Probe select = 'Both'") +
  theme_cowplot(font_size = 10) +
  annotate("text", x = 0.1, y = 0.2, hjust = 0, size = 3,
           label = glue::glue("MSE = {mse3}"))
           #label = glue::glue("Pearson correlation = {round(c3$estimate, 4)}
            #                   p-value = {signif(c3$p.value, 4)}"))

dat4 <- tibble(x = rowMeans(cbind(mixSum[,"Lymph"], 
                                 mixEstBoth$counts[,"Lymphocyte"])),
              y = (mixSum[,"Lymph"] - mixEstBoth$counts[,"Lymphocyte"])) %>%
  mutate(Mixture = factor(1:n()))
c4 <- cor.test(mixSum[,'Lymph'], mixEstBoth$counts[,'Lymphocyte'])
mse4 <- signif(mean(dat4$y^2),2)
p4 <- ggplot(dat4, aes(x = x, y = y)) +
  geom_text(label = 1:nrow(mixSum), size = 2.5) +
  #geom_point(aes(color = Mixture)) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "red") +
  labs(x = "Mean", y = "Difference (Truth - Estimate)") +
  coord_cartesian(ylim = c(-0.2, 0.2)) +
  ggtitle("Lymphocytes", subtitle = "Probe select = 'Both'") +
  theme_cowplot(font_size = 10) +
  annotate("text", x = 0.1, y = 0.2, hjust = 0, size = 3,
           label = glue::glue("MSE = {mse4}"))
           #label = glue::glue("Pearson correlation = {round(c4$estimate, 4)}
            #                   p-value = {signif(c4$p.value, 4)}"))

((p1 | p2) / (p3 | p4)) + 
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(face = 'bold', size = 16),
          legend.position = "bottom")
```
### **Figure 4**

```{r, fig.asp=1.5}
((p1a + scale_fill_brewer(palette = "Set2") + 
    theme(legend.position = "bottom",
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 9))) / 
   (wrap_elements(p1 | p2) / wrap_elements(p3 | p4)) + 
   plot_layout(heights = c(1,2)) +
   plot_annotation(tag_levels = "A") &
   theme(plot.tag = element_text(face = 'bold', size = 16)))
```

If we look at MDS plots of the mixture data, as well as of the known cell type proportions, we can see that the primary source of variation is the proportion of neutrophils vs. lymphoctes. This overlaps with the the samples where we are seeing slight over estimation of granulocyte proportions.

```{r}
mSetTargets <- preprocessRaw(RGsetTargets)
mValsTargets <- getM(mSetTargets)

mds <- plotMDS(mValsTargets, top = 1000, gene.selection = "common", 
               plot = FALSE)
dat <- tibble(x = mds$x, y = mds$y, sample = 1:12)
p1 <- ggplot(dat, aes(x = x, y = y)) +
  geom_text(aes(label = sample)) +
  labs(x = "Principal Component 1", y = "Principal Component 2")

mds <- plotMDS(mixReal, top = 1000, gene.selection = "common", 
               plot = FALSE)
dat <- tibble(x = mds$x, y = mds$y, sample = colnames(mixReal))
p2 <- ggplot(dat, aes(x = x, y = y)) +
  geom_text(aes(label = sample)) +
  labs(x = "Principal Component 1", y = "Principal Component 2")

(p1 | p2)
```

## Raw BAL samples

We can estimate the proportions of cell types in each of our raw BAL samples using our reference panel. To select the most informative cell type probes from our reference panel we can either set the '`probeSelect` paremeter to *both*, which selects an equal number (50) of probes (with F-stat p-value < 1E-8) with the greatest magnitude of effect from the hyper and hypo methylated sides; or *any*, which selects the 100 probes (with F-stat p-value < 1E-8) with the greatest magnitude of difference regardless of direction of effect.

Get estimates for proportion of each cell type using the *any* option.

```{r, message=FALSE, warning=FALSE}
patientSamps <- rgSet[, targets$Sample_Group == "Raw"]
sampleNames(patientSamps) <- targets$Sample_source[targets$Sample_Group == "Raw"]
cellEstAny <- estimateCellCounts2Mod(rgSet = patientSamps, 
                                  compositeCellType = "Lavage",   
                                  processMethod = "preprocessQuantile",  
                                  probeSelect = "any",  
                                  cellTypes = unique(targets$Sample_Group[cells]),  
                                  referencePlatform = 
                                    "IlluminaHumanMethylationEPIC",  
                                  referenceset = "lavageRef",  
                                  IDOLOptimizedCpGs = NULL,   
                                  returnAll = TRUE,
                                  meanPlot = FALSE,
                                  keepProbes = rownames(mValsNoXY))
cellEstAny$counts
```

```{r}
estAny <- reshape2::melt(cellEstAny$counts)
colnames(estAny) <- c("sample","cell","proportion")

p1 <- ggplot(estAny, aes(x = sample, fill = cell)) + 
  geom_bar(aes(weight = proportion)) +
  ggtitle("Cell type proportion estimates", 
          subtitle = "Probe selection: Any") +
  labs(x = "Sample", y = "Proportion", fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
        legend.position = "bottom") +
  scale_fill_manual(values = pal)
p1
```

Get estimates for proportion of each cell type using the *"both"* option.

```{r, message=FALSE, warning=FALSE}
cellEstBoth <- estimateCellCounts2Mod(rgSet = patientSamps, 
                                   compositeCellType = "Lavage",   
                                   processMethod = "preprocessQuantile",  
                                   probeSelect = "both",  
                                   cellTypes = unique(targets$Sample_Group[cells]),  
                                   referencePlatform =   
                                     "IlluminaHumanMethylationEPIC",  
                                   referenceset = "lavageRef",  
                                   IDOLOptimizedCpGs = NULL,   
                                   returnAll = TRUE,
                                   meanPlot = FALSE,
                                   keepProbes = rownames(mValsNoXY))
cellEstBoth$counts
```

```{r}
estBoth <- reshape2::melt(cellEstBoth$counts)
colnames(estBoth) <- c("sample","cell","proportion")

p2 <- ggplot(estBoth, aes(x = sample, fill = cell)) + 
  geom_bar(aes(weight = proportion)) +
  ggtitle("Cell type proportion estimates", 
          subtitle = "Probe selection: Both") +
  labs(x = "Sample", y = "Proportion", fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
        legend.position = "bottom") +
  scale_fill_manual(values = pal)
p2
```

```{r}
fullDat <- rbind(estBoth, estAny)
fullDat$est <- rep(c("both","any"), each = nrow(estAny))

p1 <- ggplot(fullDat, aes(x = sample, y = proportion, fill = est)) + 
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(.~ cell, scales = "free_x") +
  labs(x = "Sample", y = "Proportion", fill = "Source") +
  theme(axis.text.x = element_text(size = 8, angle = 90, hjust = 1, vjust = 0.5))

p1
```

## Compare to flow-cytometry data

```{r, fig.width=7, fig.height=8, message=FALSE, warning=FALSE}
samps <- targets$Sample_source[targets$Sample_Group == "Raw"]
melt(read.csv(here("data/Flow-Data-for-Reference-Panel-Scaled.csv"),
              stringsAsFactors = FALSE)) %>%
  mutate(variable = fct_recode(variable, CTRL = "Control")) %>%
  inner_join(melt(read.csv(here("data/Flow-Data-for-Reference-Panel-Original.csv"),
                           stringsAsFactors = FALSE)) %>%
  mutate(variable = fct_recode(variable, CTRL = "Control")), 
             by = c("X", "variable")) %>%
  rename(cell = X, 
         sample = variable, 
         scaled = value.x, 
         original = value.y) %>%
  mutate(scaled = scaled / 100,
         original = original / 100) %>%
  inner_join(estBoth[estBoth$sample %in% samps,] %>%
               rename(both = proportion) %>%
               inner_join(estAny[estBoth$sample %in% samps,] %>%
                            rename(any = proportion))  %>% 
               mutate(cell = gsub("EpithelialCell","AEC", cell),
                      cell = gsub("Macrophage","macrophages", cell),
                      cell = gsub("Granulocyte","granulocytes", cell),
                      cell = gsub("Lymphocyte","lymphocytes", cell))) %>%
  pivot_longer(cols = c(scaled, original)) -> dat

p1 <- ggplot(dat, aes(x = rowMeans(cbind(value, any)), 
                      y = value - any, colour = cell)) +
  geom_point(aes(shape = name)) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "red") +
  facet_wrap(vars(sample), ncol = 3, nrow = 2) +
  labs(x = "Mean", y = "Difference (Flow - Meth. est.)",
       colour = "Cell Type", shape = "Flow Data") +
  scale_shape_manual(values = c(1,4)) +
  ggtitle("Probe selection: Any")

p2 <- ggplot(dat, aes(x = rowMeans(cbind(value, both)), 
                      y = value - both, colour = cell)) +
  geom_point(aes(shape = name)) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "red") +
  facet_wrap(vars(sample), ncol = 3, nrow = 2) +
  labs(x = "Mean", y = "Difference (Flow - Meth. est.)",
       colour = "Cell Type", shape = "Flow Data") +
  scale_shape_manual(values = c(1,4)) +
  ggtitle("Probe selection: Both")

p1 / p2 + plot_layout(guides = "collect")
```


<!-- ```{r, warning=FALSE, message=FALSE, fig.width=8, fig.height=13} -->
<!-- anyfitlm <- vector("list", 6) -->
<!-- i = 1 -->
<!-- for(s in unique(as.character(dat$sample))){ -->
<!--   for(n in unique(dat$name)){ -->
<!--     data <- dat[dat$sample == s & dat$name == n,] -->
<!--     anyfitlm[[i]] <- data.frame(fit = predict(lm(any ~ value, data = data)), -->
<!--                       sample = s, -->
<!--                       name = n, -->
<!--                       cell = dat$cell[dat$sample == s & dat$name == n]) -->

<!--     i = i + 1 -->
<!--   }    -->
<!-- } -->
<!-- anyfitlm <- bind_rows(anyfitlm) -->

<!-- bothfitlm <- vector("list", 6) -->
<!-- i = 1 -->
<!-- for(s in unique(dat$sample)){ -->
<!--   for(n in unique(dat$name)){ -->
<!--     data <- dat[dat$sample == s & dat$name == n,] -->
<!--     bothfitlm[[i]] <- data.frame(fit = predict(lm(both ~ value, data = data)), -->
<!--                       sample = s, -->
<!--                       name = n, -->
<!--                       cell = dat$cell[dat$sample == s & dat$name == n]) -->
<!--     i = i + 1 -->
<!--   }    -->
<!-- } -->
<!-- bothfitlm <- bind_rows(bothfitlm) -->

<!-- fitDat <- inner_join(dat, anyfitlm,  -->
<!--                      by = c("sample","name","cell")) %>% -->
<!--   inner_join(bothfitlm, -->
<!--              by = c("sample","name","cell"), -->
<!--              suffix = c(".any", ".both")) -->

<!-- newPal <- pal[-2] -->
<!-- names(newPal) <- c("granulocytes","lymphocytes","macrophages","AEC") -->

<!-- samps <- as.character(unique(fitDat$sample)) -->
<!-- p1 <- vector("list", length(samps)) -->

<!-- for(i in 1:length(samps)){ -->
<!--   dat1 <- dplyr::filter(fitDat, sample == samps[i] & name == "original") -->
<!--   c1 <- cor.test(dat1$any, dat1$value) -->
<!--   p1[[i]] <- ggplot(dat1, aes(x = value, y = any)) + -->
<!--     geom_point(aes(colour = cell), size = 3) + -->
<!--     geom_line(aes(y = fit.any), colour = "darkgrey", linetype = "dashed") +  -->
<!--     labs(x = "Flow cytometry measure", y = "DNAm estimate", -->
<!--          colour = "Cell type") + -->
<!--     coord_cartesian(ylim = c(0, 1), xlim = c(0, 1)) + -->
<!--     ggtitle(samps[i]) + -->
<!--     scale_color_manual(values = newPal) +  -->
<!--     annotate("text", x = 0, y = 0.9, hjust = 0, size = 2.5, -->
<!--              label = glue::glue("Cor (Pearson) = {round(c1$estimate, 4)} -->
<!--                                p-value = {signif(c1$p.value, 4)}")) + -->
<!--     theme(plot.title = element_text(size = 10), -->
<!--           axis.title = element_text(size = 9), -->
<!--           axis.text = element_text(size = 8)) -->

<!-- } -->

<!-- p2 <- vector("list", length(samps)) -->

<!-- for(i in 1:length(samps)){ -->
<!--   dat1 <- dplyr::filter(fitDat, sample == samps[i] & name == "scaled") -->
<!--   c1 <- cor.test(dat1$any, dat1$value) -->
<!--   p2[[i]] <- ggplot(dat1, aes(x = value, y = any)) + -->
<!--     geom_point(aes(colour = cell), size = 3) + -->
<!--     geom_line(aes(y = fit.any), colour = "darkgrey", linetype = "dashed") +  -->
<!--     labs(x = "Flow cytometry measure", y = "DNAm estimate", -->
<!--          colour = "Cell type") + -->
<!--     coord_cartesian(ylim = c(0, 1), xlim = c(0, 1)) + -->
<!--     ggtitle(samps[i]) + -->
<!--     scale_color_manual(values = newPal) +  -->
<!--     annotate("text", x = 0, y = 0.9, hjust = 0, size = 2.5, -->
<!--              label = glue::glue("Cor (Pearson) = {round(c1$estimate, 4)} -->
<!--                                p-value = {signif(c1$p.value, 4)}")) + -->
<!--     theme(plot.title = element_text(size = 10), -->
<!--           axis.title = element_text(size = 9), -->
<!--           axis.text = element_text(size = 8)) -->

<!-- } -->

<!-- p3 <- vector("list", length(samps)) -->

<!-- for(i in 1:length(samps)){ -->
<!--   dat1 <- dplyr::filter(fitDat, sample == samps[i] & name == "original") -->
<!--   c1 <- cor.test(dat1$both, dat1$value) -->
<!--   p3[[i]] <- ggplot(dat1, aes(x = value, y = both)) + -->
<!--     geom_point(aes(colour = cell), size = 3) + -->
<!--     geom_line(aes(y = fit.both), colour = "darkgrey", linetype = "dashed") +  -->
<!--     labs(x = "Flow cytometry measure", y = "DNAm estimate", -->
<!--          colour = "Cell type") + -->
<!--     coord_cartesian(ylim = c(0, 1), xlim = c(0, 1)) + -->
<!--     ggtitle(samps[i]) + -->
<!--     scale_color_manual(values = newPal) +  -->
<!--     annotate("text", x = 0, y = 0.9, hjust = 0, size = 2.5, -->
<!--              label = glue::glue("Cor (Pearson) = {round(c1$estimate, 4)} -->
<!--                                p-value = {signif(c1$p.value, 4)}")) + -->
<!--     theme(plot.title = element_text(size = 10), -->
<!--           axis.title = element_text(size = 9), -->
<!--           axis.text = element_text(size = 8)) -->

<!-- } -->

<!-- p4 <- vector("list", length(samps)) -->

<!-- for(i in 1:length(samps)){ -->
<!--   dat1 <- dplyr::filter(fitDat, sample == samps[i] & name == "scaled") -->
<!--   c1 <- cor.test(dat1$both, dat1$value) -->
<!--   p4[[i]] <- ggplot(dat1, aes(x = value, y = both)) + -->
<!--     geom_point(aes(colour = cell), size = 3) + -->
<!--     geom_line(aes(y = fit.both), colour = "darkgrey", linetype = "dashed") +  -->
<!--     labs(x = "Flow cytometry measure", y = "DNAm estimate", -->
<!--          colour = "Cell type") + -->
<!--     coord_cartesian(ylim = c(0, 1), xlim = c(0, 1)) + -->
<!--     ggtitle(samps[i]) + -->
<!--     scale_color_manual(values = newPal) +  -->
<!--     annotate("text", x = 0, y = 0.9, hjust = 0, size = 2.5, -->
<!--              label = glue::glue("Cor (Pearson) = {round(c1$estimate, 4)} -->
<!--                                p-value = {signif(c1$p.value, 4)}")) + -->
<!--     theme(plot.title = element_text(size = 10), -->
<!--           axis.title = element_text(size = 9), -->
<!--           axis.text = element_text(size = 8)) -->

<!-- } -->

<!-- a <- wrap_plots(p1, ncol = 3, guides = "collect") + -->
<!--   plot_annotation(title = "Probe selection: Any - Flow data: Original") &  -->
<!--   theme(legend.position = "none", -->
<!--           plot.title = element_text(size = 12)) -->
<!-- b <- wrap_plots(p2, ncol = 3, guides = "collect") + -->
<!--   plot_annotation(title = "Probe selection: Any - Flow data: Scaled") &  -->
<!--   theme(legend.position = "bottom", -->
<!--           plot.title = element_text(size = 12)) -->
<!-- c <- wrap_plots(p3, ncol = 3, guides = "collect") + -->
<!--   plot_annotation(title = "Probe selection: Both - Flow data: Original") &  -->
<!--   theme(legend.position = "none", -->
<!--           plot.title = element_text(size = 12)) -->
<!-- d <- wrap_plots(p4, ncol = 3, guides = "collect") + -->
<!--   plot_annotation(title = "Probe selection: Both - Flow data: Scaled") &  -->
<!--   theme(legend.position = "bottom", -->
<!--           plot.title = element_text(size = 12)) -->

<!-- ab <- (wrap_elements(a) / wrap_elements(b)) +  -->
<!--   plot_layout(guides = "collect") +  -->
<!--   plot_annotation(tag_levels = "A") & -->
<!--     theme(plot.tag = element_text(face = 'bold', size = 16)) -->

<!-- cd <- (wrap_elements(c) / wrap_elements(d)) +  -->
<!--   plot_layout(guides = "collect") +  -->
<!--   plot_annotation(tag_levels = "A") & -->
<!--     theme(plot.tag = element_text(face = 'bold', size = 16)) -->

<!-- ab -->
<!-- cd -->
<!-- ``` -->


```{r, fig.width=8, fig.height=13}
newPal <- pal[-2]
names(newPal) <- c("granulocytes","lymphocytes","macrophages","AEC")
samps <- as.character(unique(dat$sample))
p <- vector("list", length(samps))

for(i in 1:length(samps)){
  dat1 <- filter(dat, sample == samps[i])
  dat1 %>% filter(name == "original") %>% 
    mutate(dsq = (value - any)^2) %>% 
    pull(dsq) %>% mean() %>% 
    signif(2) -> omse
  dat1 %>% filter(name == "scaled") %>% 
    mutate(dsq = (value - any)^2) %>% 
    pull(dsq) %>% mean() %>% 
    signif(2) -> smse
  c1 <- cor.test(dat1$any, dat1$value)
  p[[i]] <- ggplot(dat1, aes(x = rowMeans(cbind(value, any)), 
                         y = value - any, colour = cell)) +
    geom_point(aes(shape = name)) +
    scale_color_manual(values = newPal) +
    scale_shape_manual(values = c(1,4)) +
    geom_hline(yintercept = 0, linetype = "dashed", colour = "red") +
    labs(x = "Mean", y = "Difference (Flow - Meth. est.)",
         colour = "Cell type", shape = "Measure") +
    coord_cartesian(ylim = c(-0.5, 0.5), xlim = c(0, 1)) +
    ggtitle({samps[i]}) +
    theme_cowplot(font_size = 8) +
    annotate("text", x = 0, y = 0.40, hjust = 0, size = 2.5,
             label = glue::glue("MSE (original) = {omse}
                               MSE (scaled) = {smse}"))
             #label = glue::glue("Pearson correlation = {round(c1$estimate, 4)}
              #                 p-value = {signif(c1$p.value, 4)}"))
  
}

p1 <- wrap_plots(p, ncol = 3, guides = "collect") +
  plot_annotation(title = "Probe select = 'Any'") & 
  theme(legend.position = "none")

for(i in 1:length(samps)){
  dat1 <- filter(dat, sample == samps[i])
   dat1 %>% filter(name == "original") %>% 
    mutate(dsq = (value - both)^2) %>% 
    pull(dsq) %>% mean() %>% 
    signif(2) -> omse
  dat1 %>% filter(name == "scaled") %>% 
    mutate(dsq = (value - both)^2) %>% 
    pull(dsq) %>% mean() %>% 
    signif(2) -> smse
  c1 <- cor.test(dat1$both, dat1$value)
  p[[i]] <- ggplot(dat1, aes(x = rowMeans(cbind(value, both)), 
                         y = value - both, colour = cell)) +
    geom_point(aes(shape = name)) +
    scale_shape_manual(values = c(1,4)) +
    scale_color_manual(values = newPal) +
    geom_hline(yintercept = 0, linetype = "dashed", colour = "red") +
    labs(x = "Mean", y = "Difference (Flow - Meth. est.)",
         colour = "Cell type", shape = "Measure") +
    coord_cartesian(ylim = c(-0.5, 0.5), xlim = c(0, 1)) +
    ggtitle(samps[i]) +
    theme_cowplot(font_size = 8) +
    annotate("text", x = 0, y = 0.40, hjust = 0, size = 2.5,
             label = glue::glue("MSE (original) = {omse}
                               MSE (scaled) = {smse}"))
             #label = glue::glue("Pearson correlation = {round(c1$estimate, 4)}
              #                 p-value = {signif(c1$p.value, 4)}"))
  
}

p2 <- wrap_plots(p, ncol = 3, guides = "collect") +
  plot_annotation(title = "Probe select = 'Both'") & 
  theme(legend.position = "bottom", legend.box = "vertical")

(wrap_elements(p1) / wrap_elements(p2)) + 
  plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(face = 'bold', size = 16))
```

# **Figure 5** 

```{r, fig.asp=2}
dat %>% select(cell, sample, value, name) %>%
  bind_rows(dat %>% select(cell, sample, both) %>% 
              rename(value = both) %>%
              mutate(name = "both")) %>%
  bind_rows(dat %>% select(cell, sample, any) %>% 
              rename(value = any) %>%
              mutate(name = "any")) -> longDat

p1a <- ggplot(longDat, aes(x = sample, y = value, fill = name)) + 
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(.~ cell, scales = "free_x") +
  labs(x = "Cell type", y = "Proportion", fill = "Source") + 
  theme_cowplot() 

((p1a + scale_fill_brewer(palette = "Set2") + 
    theme(legend.position = "bottom",
              legend.text = element_text(size = 8),
              legend.title = element_text(size = 9),
          axis.text = element_text(size = 8),
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
          axis.title = element_text(size = 10))) / 
   wrap_elements(p1) / wrap_elements(p2)) + 
  plot_layout(heights = c(1,2,2)) +
  plot_annotation(tag_levels = "A") &
    theme(plot.tag = element_text(face = 'bold', size = 16))
```


<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Jovana Maksimovic" />

<meta name="date" content="2021-11-23" />

<title>Methylation profiling of paediatric Bronchoalveolar Lavage (BAL)</title>

<script src="site_libs/header-attrs-2.6/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<link rel="icon" href="https://github.com/workflowr/workflowr-assets/raw/master/img/reproducible.png">
<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>



<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">paed-BAL-meth-ref</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Methylation profiling of paediatric Bronchoalveolar Lavage (BAL)</h1>
<h3 class="subtitle">Estimating cell type proportions of raw paediatric BAL</h3>
<h4 class="author">Jovana Maksimovic</h4>
<h4 class="date">2021-11-23</h4>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span> workflowr <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks"> Checks <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> </a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2021-11-23
</p>
<p>
<strong>Checks:</strong> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> 7 <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> 0
</p>
<p>
<strong>Knit directory:</strong> <code>paed-BAL-meth-ref/</code> <span class="glyphicon glyphicon-question-sign" aria-hidden="true" title="This is the local directory in which the code in this file was executed."> </span>
</p>
<p>
This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a> analysis was created with <a
  href="https://github.com/jdblischak/workflowr">workflowr</a> (version 1.6.2). The <em>Checks</em> tab describes the reproducibility checks that were applied when the results were created. The <em>Past versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguptodate"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>R Markdown file:</strong> up-to-date </a>
</p>
</div>
<div id="strongRMarkdownfilestronguptodate" class="panel-collapse collapse">
<div class="panel-body">
<p>Great! Since the R Markdown file has been committed to the Git repository, you know the exact version of the code that produced these results.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Environment:</strong> empty </a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the global environment can affect the analysis in your R Markdown file in unknown ways. For reproduciblity it’s best to always run the code in an empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20210927code"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Seed:</strong> <code>set.seed(20210927)</code> </a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20210927code" class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20210927)</code> was run prior to running the code in the R Markdown file. Setting a seed ensures that any results that rely on randomness, e.g. subsampling or permutations, are reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Session information:</strong> recorded </a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package versions is critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Cache:</strong> none </a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be confident that you successfully produced the results during this run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongrelative"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>File paths:</strong> relative </a>
</p>
</div>
<div id="strongFilepathsstrongrelative" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Using relative paths to the files within your workflowr project makes it easier to run your code on other machines.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsatlassianpetermacorgaubitbucketscmospaedbalmethreftree4675ddecc968872d00b256d6956fe401768b3e1dtargetblank4675ddea"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Repository version:</strong> <a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/tree/4675ddecc968872d00b256d6956fe401768b3e1d" target="_blank">4675dde</a> </a>
</p>
</div>
<div id="strongRepositoryversionstrongahrefhttpsatlassianpetermacorgaubitbucketscmospaedbalmethreftree4675ddecc968872d00b256d6956fe401768b3e1dtargetblank4675ddea" class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development and connecting the code version to the results is critical for reproducibility.
</p>
<p>
The results in this page were generated with repository version <a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/tree/4675ddecc968872d00b256d6956fe401768b3e1d" target="_blank">4675dde</a>. See the <em>Past versions</em> tab to see a history of the changes made to the R Markdown and HTML files.
</p>
<p>
Note that you need to be careful to ensure that all relevant files for the analysis have been committed to Git prior to generating the results (you can use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only checks the R Markdown file, but you know if there are other scripts or data files that it depends on. Below is the status of the Git repository when the results were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .Rhistory
    Ignored:    .Rproj.user/
    Ignored:    code/deident.R
    Ignored:    code/geoprep.R
    Ignored:    data/idat/
    Ignored:    data/processedData.RData
    Ignored:    output/GO-Any.csv
    Ignored:    output/GO-Both.csv
    Ignored:    output/GO-Diff.csv
    Ignored:    output/GO-Same.csv
    Ignored:    output/intensities.csv
    Ignored:    output/processed.csv

Unstaged changes:
    Modified:   .gitignore
    Modified:   data/Samplesheet_BAL_reference.csv

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in this status report because it is ok for generated content to have uncommitted changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the repository in which changes were made to the R Markdown (<code>analysis/estimateCellProportions.Rmd</code>) and HTML (<code>docs/estimateCellProportions.html</code>) files. If you’ve configured a remote Git repository (see <code>?wflow_git_remote</code>), click on the hyperlinks in the table below to view the files as they were in that past version.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/4675ddecc968872d00b256d6956fe401768b3e1d/analysis/estimateCellProportions.Rmd" target="_blank">4675dde</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-11-23
</td>
<td>
wflow_publish(c(“analysis/dataPreprocess.Rmd”, “analysis/estimateCellProportions.Rmd”))
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/215068501d56b6ac71bcab25e0a4cfc2141f4139/docs/estimateCellProportions.html" target="_blank">2150685</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-10-01
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/56c3bda3e88d382a8a6bb500cb3ba75453519e84/analysis/estimateCellProportions.Rmd" target="_blank">56c3bda</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-10-01
</td>
<td>
wflow_publish(c(“analysis/estimateCellProportions.Rmd”))
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/a90dc68a9e8608ef7e5fe16f02059495870f6fd6/docs/estimateCellProportions.html" target="_blank">a90dc68</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-28
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/e968190c85470b191cab0de6adabaa18a60ace5c/analysis/estimateCellProportions.Rmd" target="_blank">e968190</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-28
</td>
<td>
wflow_publish(c(“analysis/dataPreprocess.Rmd”, “analysis/estimateCellProportions.Rmd”))
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/f75f3f51a0ed4fc257ac35a61e4fb600ea7f3165/docs/estimateCellProportions.html" target="_blank">f75f3f5</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-28
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/2bd43cc6df0685982254d3eb180802a33ee74b19/analysis/estimateCellProportions.Rmd" target="_blank">2bd43cc</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-28
</td>
<td>
wflow_publish(“analysis/estimateCellProportions.Rmd”)
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/10147c01aaa38682abaf4f3694d1ce55fc634e06/docs/estimateCellProportions.html" target="_blank">10147c0</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-27
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/1114da3d98ebc1f90be57f2626e71b16d7ea20f7/analysis/estimateCellProportions.Rmd" target="_blank">1114da3</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-27
</td>
<td>
wflow_publish(c(“analysis/index.Rmd”, “analysis/dataPreprocess.Rmd”,
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<div id="data-import" class="section level1">
<h1>Data import</h1>
<p>Load all necessary analysis packages.</p>
<pre class="r"><code>library(here)
library(workflowr)
library(glue)
#Load Packages Required for Analysis
library(limma)
library(minfi)
library(matrixStats)
library(IlluminaHumanMethylationEPICanno.ilm10b4.hg19)
library(IlluminaHumanMethylationEPICmanifest)
library(FlowSorted.Blood.EPIC)
library(ggplot2)
library(ExperimentHub)
library(reshape2)
library(tidyverse)
library(patchwork)
library(missMethyl)
library(cowplot)</code></pre>
<p>Load raw and processed data objects generated by exploratory analysis.</p>
<pre class="r"><code># load data objects
load(here(&quot;data/processedData.RData&quot;))
# load modified cell type estimation function
source(here(&quot;code/functions.R&quot;))</code></pre>
<p>As expected, we see clear clustering by cell types.</p>
<pre class="r"><code>mds &lt;- plotMDS(mVals[, cells], top = 1000, gene.selection=&quot;common&quot;, plot = FALSE)
dat &lt;- tibble(x = mds$x, 
              y = mds$y, 
              sample = targets$Sample_Group[cells], 
              run = targets$Sample_run[cells],
              ID = targets$Sample_ID[cells])

p &lt;- ggplot(dat, aes(x = x, y = y, colour = sample)) +
  geom_point(aes(shape = run), size = 3) +
  labs(colour = &quot;Sample type&quot;, shape = &quot;Run&quot;,
       x = &quot;Principal component 1&quot;, 
       y = &quot;Principal component 2&quot;) +
  ggtitle(&quot;Cell types&quot;) +
  scale_color_manual(values = pal[-2])
p</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-3-1">
Past versions of unnamed-chunk-3-1.png
</button>
</p>
<div id="fig-unnamed-chunk-3-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/10147c01aaa38682abaf4f3694d1ce55fc634e06/docs/figure/estimateCellProportions.Rmd/unnamed-chunk-3-1.png" target="_blank">10147c0</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-27
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="identify-cell-type-discriminating-probes" class="section level1">
<h1>Identify cell type discriminating probes</h1>
<p>Identify cell type discriminating probesusing the <em>any</em> and <em>both</em> method (<em>both</em> selects an equal number (50) of probes (with F-stat p-value &lt; 1E-8) with the greatest magnitude of effect from the hyper and hypo methylated sides; or <em>any</em>, which selects the 100 probes (with F-stat p-value &lt; 1E-8) with the greatest magnitude of difference regardless of direction of effect.).</p>
<pre class="r"><code>mSetSqFlt$CellType &lt;- as.character(targets$Sample_Group)

pAny &lt;- minfi:::pickCompProbes(mSet = mSetSqFlt[rownames(mSetSqFlt) %in% rownames(mValsNoXY),
                                                cells], probeSelect = &quot;any&quot;,
                       numProbes = 50, compositeCellType = &quot;Lavage&quot;, 
                       cellTypes = unique(targets$Sample_Group[cells]))
pBoth &lt;- minfi:::pickCompProbes(mSet = mSetSqFlt[rownames(mSetSqFlt) %in% rownames(mValsNoXY),
                                                 cells], probeSelect = &quot;both&quot;,
                       numProbes = 50, compositeCellType = &quot;Lavage&quot;, 
                       cellTypes = unique(targets$Sample_Group[cells]))</code></pre>
<div id="compare-different-selection-methods" class="section level2">
<h2>Compare different selection methods</h2>
<p>Use a heatmap to visulalise the methylation of the cell type discriminating probes in the cell sorted samples.</p>
<div id="figure-3" class="section level3">
<h3><strong>Figure 3</strong></h3>
<pre class="r"><code>par(mfrow=c(1,2))
NMF::aheatmap(bVals[rownames(bVals) %in% rownames(pAny$coefEsts), cells],
         annCol = list(CellType = as.character(targets$Sample_Group[cells])), 
         labCol = NA, labRow = NA, annColors = list(pal[-2]),
         main=&quot;A. Probe select = &#39;Any&#39;&quot;)

NMF::aheatmap(bVals[rownames(bVals) %in% rownames(pBoth$coefEsts), cells],
         annCol = list(CellType = as.character(targets$Sample_Group[cells])), 
         labCol = NA, labRow = NA, annColors = list(pal[-2]),
         main=&quot;B. Probe select = &#39;Both&#39;&quot;)</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-5-1.png" width="960" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-5-1">
Past versions of unnamed-chunk-5-1.png
</button>
</p>
<div id="fig-unnamed-chunk-5-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/10147c01aaa38682abaf4f3694d1ce55fc634e06/docs/figure/estimateCellProportions.Rmd/unnamed-chunk-5-1.png" target="_blank">10147c0</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-27
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="characteristics-of-probes-selected-using-any" class="section level2">
<h2>Characteristics of probes selected using <em>“any”</em></h2>
<pre class="r"><code>ann &lt;- getAnnotation(IlluminaHumanMethylationEPICanno.ilm10b4.hg19)
sub &lt;- targets[targets$Sample_Group != &quot;Raw&quot;,]
tmp &lt;- mValsNoXY[rownames(mValsNoXY) %in% rownames(pAny$coefEsts), 
                 colnames(mValsNoXY) %in% sub$Sample_ID]
tmpAny &lt;- ann[match(rownames(tmp), ann$Name), -c(5:17,20,21,23,32:37)]

topAnyFile &lt;- here(&quot;output&quot;,
                   glue(&quot;GO-Any.csv&quot;))

if(!file.exists(topAnyFile)){
  gstAny &lt;- gometh(sig.cpg = rownames(pAny$coefEsts), 
                   all.cpg = rownames(mValsNoXY), 
                   anno = ann)
  topAny &lt;- topGSA(gstAny, number = 50)
  write.csv(topAny, topAnyFile)
  
} else {
  topAny &lt;- read.csv(topAnyFile, row.names = 1)
  
}

topAny %&gt;% knitr::kable()</code></pre>
<table style="width:100%;">
<colgroup>
<col width="8%" />
<col width="7%" />
<col width="62%" />
<col width="3%" />
<col width="2%" />
<col width="7%" />
<col width="7%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">ONTOLOGY</th>
<th align="left">TERM</th>
<th align="right">N</th>
<th align="right">DE</th>
<th align="right">P.DE</th>
<th align="right">FDR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><a href="GO:0045321" class="uri">GO:0045321</a></td>
<td align="left">BP</td>
<td align="left">leukocyte activation</td>
<td align="right">1197</td>
<td align="right">37</td>
<td align="right">0.0000054</td>
<td align="right">0.1223846</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0042110" class="uri">GO:0042110</a></td>
<td align="left">BP</td>
<td align="left">T cell activation</td>
<td align="right">464</td>
<td align="right">20</td>
<td align="right">0.0000268</td>
<td align="right">0.2365053</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0006955" class="uri">GO:0006955</a></td>
<td align="left">BP</td>
<td align="left">immune response</td>
<td align="right">1912</td>
<td align="right">45</td>
<td align="right">0.0000431</td>
<td align="right">0.2365053</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0007159" class="uri">GO:0007159</a></td>
<td align="left">BP</td>
<td align="left">leukocyte cell-cell adhesion</td>
<td align="right">348</td>
<td align="right">16</td>
<td align="right">0.0000447</td>
<td align="right">0.2365053</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:1903037" class="uri">GO:1903037</a></td>
<td align="left">BP</td>
<td align="left">regulation of leukocyte cell-cell adhesion</td>
<td align="right">314</td>
<td align="right">15</td>
<td align="right">0.0000523</td>
<td align="right">0.2365053</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0001775" class="uri">GO:0001775</a></td>
<td align="left">BP</td>
<td align="left">cell activation</td>
<td align="right">1351</td>
<td align="right">38</td>
<td align="right">0.0000648</td>
<td align="right">0.2442241</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0050851" class="uri">GO:0050851</a></td>
<td align="left">BP</td>
<td align="left">antigen receptor-mediated signaling pathway</td>
<td align="right">235</td>
<td align="right">13</td>
<td align="right">0.0001199</td>
<td align="right">0.3725532</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0002684" class="uri">GO:0002684</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of immune system process</td>
<td align="right">950</td>
<td align="right">28</td>
<td align="right">0.0001597</td>
<td align="right">0.3725532</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0002768" class="uri">GO:0002768</a></td>
<td align="left">BP</td>
<td align="left">immune response-regulating cell surface receptor signaling pathway</td>
<td align="right">384</td>
<td align="right">17</td>
<td align="right">0.0001673</td>
<td align="right">0.3725532</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0002764" class="uri">GO:0002764</a></td>
<td align="left">BP</td>
<td align="left">immune response-regulating signaling pathway</td>
<td align="right">387</td>
<td align="right">17</td>
<td align="right">0.0001731</td>
<td align="right">0.3725532</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0002429" class="uri">GO:0002429</a></td>
<td align="left">BP</td>
<td align="left">immune response-activating cell surface receptor signaling pathway</td>
<td align="right">353</td>
<td align="right">16</td>
<td align="right">0.0001976</td>
<td align="right">0.3725532</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0002757" class="uri">GO:0002757</a></td>
<td align="left">BP</td>
<td align="left">immune response-activating signal transduction</td>
<td align="right">353</td>
<td align="right">16</td>
<td align="right">0.0001976</td>
<td align="right">0.3725532</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0002682" class="uri">GO:0002682</a></td>
<td align="left">BP</td>
<td align="left">regulation of immune system process</td>
<td align="right">1458</td>
<td align="right">37</td>
<td align="right">0.0002646</td>
<td align="right">0.4604714</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0046649" class="uri">GO:0046649</a></td>
<td align="left">BP</td>
<td align="left">lymphocyte activation</td>
<td align="right">661</td>
<td align="right">22</td>
<td align="right">0.0003418</td>
<td align="right">0.5270029</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0042060" class="uri">GO:0042060</a></td>
<td align="left">BP</td>
<td align="left">wound healing</td>
<td align="right">514</td>
<td align="right">21</td>
<td align="right">0.0003495</td>
<td align="right">0.5270029</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0050900" class="uri">GO:0050900</a></td>
<td align="left">BP</td>
<td align="left">leukocyte migration</td>
<td align="right">442</td>
<td align="right">16</td>
<td align="right">0.0005924</td>
<td align="right">0.7996714</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0045579" class="uri">GO:0045579</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of B cell differentiation</td>
<td align="right">11</td>
<td align="right">3</td>
<td align="right">0.0006356</td>
<td align="right">0.7996714</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0042117" class="uri">GO:0042117</a></td>
<td align="left">BP</td>
<td align="left">monocyte activation</td>
<td align="right">10</td>
<td align="right">3</td>
<td align="right">0.0006594</td>
<td align="right">0.7996714</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0002252" class="uri">GO:0002252</a></td>
<td align="left">BP</td>
<td align="left">immune effector process</td>
<td align="right">1149</td>
<td align="right">29</td>
<td align="right">0.0006717</td>
<td align="right">0.7996714</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0002280" class="uri">GO:0002280</a></td>
<td align="left">BP</td>
<td align="left">monocyte activation involved in immune response</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="right">0.0007406</td>
<td align="right">0.8376712</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0002253" class="uri">GO:0002253</a></td>
<td align="left">BP</td>
<td align="left">activation of immune response</td>
<td align="right">436</td>
<td align="right">16</td>
<td align="right">0.0007811</td>
<td align="right">0.8414019</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0044706" class="uri">GO:0044706</a></td>
<td align="left">BP</td>
<td align="left">multi-multicellular organism process</td>
<td align="right">214</td>
<td align="right">10</td>
<td align="right">0.0009203</td>
<td align="right">0.9462395</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0000506" class="uri">GO:0000506</a></td>
<td align="left">CC</td>
<td align="left">glycosylphosphatidylinositol-N-acetylglucosaminyltransferase (GPI-GnT) complex</td>
<td align="right">7</td>
<td align="right">2</td>
<td align="right">0.0010079</td>
<td align="right">0.9482012</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0033292" class="uri">GO:0033292</a></td>
<td align="left">BP</td>
<td align="left">T-tubule organization</td>
<td align="right">9</td>
<td align="right">3</td>
<td align="right">0.0010734</td>
<td align="right">0.9482012</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0050776" class="uri">GO:0050776</a></td>
<td align="left">BP</td>
<td align="left">regulation of immune response</td>
<td align="right">868</td>
<td align="right">23</td>
<td align="right">0.0011227</td>
<td align="right">0.9482012</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0002274" class="uri">GO:0002274</a></td>
<td align="left">BP</td>
<td align="left">myeloid leukocyte activation</td>
<td align="right">638</td>
<td align="right">19</td>
<td align="right">0.0011231</td>
<td align="right">0.9482012</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0050778" class="uri">GO:0050778</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of immune response</td>
<td align="right">631</td>
<td align="right">19</td>
<td align="right">0.0011318</td>
<td align="right">0.9482012</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0090575" class="uri">GO:0090575</a></td>
<td align="left">CC</td>
<td align="left">RNA polymerase II transcription regulator complex</td>
<td align="right">153</td>
<td align="right">9</td>
<td align="right">0.0013139</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0071889" class="uri">GO:0071889</a></td>
<td align="left">MF</td>
<td align="left">14-3-3 protein binding</td>
<td align="right">32</td>
<td align="right">5</td>
<td align="right">0.0014092</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0047756" class="uri">GO:0047756</a></td>
<td align="left">MF</td>
<td align="left">chondroitin 4-sulfotransferase activity</td>
<td align="right">3</td>
<td align="right">2</td>
<td align="right">0.0014457</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:2000401" class="uri">GO:2000401</a></td>
<td align="left">BP</td>
<td align="left">regulation of lymphocyte migration</td>
<td align="right">61</td>
<td align="right">5</td>
<td align="right">0.0014616</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0022407" class="uri">GO:0022407</a></td>
<td align="left">BP</td>
<td align="left">regulation of cell-cell adhesion</td>
<td align="right">423</td>
<td align="right">16</td>
<td align="right">0.0015827</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0072676" class="uri">GO:0072676</a></td>
<td align="left">BP</td>
<td align="left">lymphocyte migration</td>
<td align="right">110</td>
<td align="right">6</td>
<td align="right">0.0015912</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0009611" class="uri">GO:0009611</a></td>
<td align="left">BP</td>
<td align="left">response to wounding</td>
<td align="right">631</td>
<td align="right">22</td>
<td align="right">0.0020200</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0050765" class="uri">GO:0050765</a></td>
<td align="left">BP</td>
<td align="left">negative regulation of phagocytosis</td>
<td align="right">21</td>
<td align="right">3</td>
<td align="right">0.0020369</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:1903039" class="uri">GO:1903039</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of leukocyte cell-cell adhesion</td>
<td align="right">225</td>
<td align="right">10</td>
<td align="right">0.0023518</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0002263" class="uri">GO:0002263</a></td>
<td align="left">BP</td>
<td align="left">cell activation involved in immune response</td>
<td align="right">691</td>
<td align="right">19</td>
<td align="right">0.0024561</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0016427" class="uri">GO:0016427</a></td>
<td align="left">MF</td>
<td align="left">tRNA (cytosine) methyltransferase activity</td>
<td align="right">8</td>
<td align="right">2</td>
<td align="right">0.0025014</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0032940" class="uri">GO:0032940</a></td>
<td align="left">BP</td>
<td align="left">secretion by cell</td>
<td align="right">1368</td>
<td align="right">35</td>
<td align="right">0.0025651</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0097470" class="uri">GO:0097470</a></td>
<td align="left">CC</td>
<td align="left">ribbon synapse</td>
<td align="right">11</td>
<td align="right">3</td>
<td align="right">0.0026002</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:1990266" class="uri">GO:1990266</a></td>
<td align="left">BP</td>
<td align="left">neutrophil migration</td>
<td align="right">115</td>
<td align="right">6</td>
<td align="right">0.0026339</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0001025" class="uri">GO:0001025</a></td>
<td align="left">MF</td>
<td align="left">RNA polymerase III general transcription initiation factor binding</td>
<td align="right">3</td>
<td align="right">2</td>
<td align="right">0.0026871</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0001156" class="uri">GO:0001156</a></td>
<td align="left">MF</td>
<td align="left">TFIIIC-class transcription factor complex binding</td>
<td align="right">3</td>
<td align="right">2</td>
<td align="right">0.0026871</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0010452" class="uri">GO:0010452</a></td>
<td align="left">BP</td>
<td align="left">histone H3-K36 methylation</td>
<td align="right">14</td>
<td align="right">3</td>
<td align="right">0.0027548</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0045648" class="uri">GO:0045648</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of erythrocyte differentiation</td>
<td align="right">31</td>
<td align="right">4</td>
<td align="right">0.0027781</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0043374" class="uri">GO:0043374</a></td>
<td align="left">BP</td>
<td align="left">CD8-positive, alpha-beta T cell differentiation</td>
<td align="right">15</td>
<td align="right">3</td>
<td align="right">0.0028800</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0010793" class="uri">GO:0010793</a></td>
<td align="left">BP</td>
<td align="left">regulation of mRNA export from nucleus</td>
<td align="right">5</td>
<td align="right">2</td>
<td align="right">0.0029618</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0034481" class="uri">GO:0034481</a></td>
<td align="left">MF</td>
<td align="left">chondroitin sulfotransferase activity</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">0.0030074</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0050863" class="uri">GO:0050863</a></td>
<td align="left">BP</td>
<td align="left">regulation of T cell activation</td>
<td align="right">321</td>
<td align="right">12</td>
<td align="right">0.0030207</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0002376" class="uri">GO:0002376</a></td>
<td align="left">BP</td>
<td align="left">immune system process</td>
<td align="right">2849</td>
<td align="right">57</td>
<td align="right">0.0030691</td>
<td align="right">1.0000000</td>
</tr>
</tbody>
</table>
<pre class="r"><code>flatAnn &lt;- missMethyl:::.getFlatAnnotation(&quot;EPIC&quot;)
dat &lt;- tmpAny
dat %&gt;% data.frame %&gt;%
  left_join(flatAnn, by = c(&quot;Name&quot; = &quot;cpg&quot;)) -&gt; dat

dat %&gt;%
ggplot(aes(x = Relation_to_Island, 
           fill = Relation_to_Island)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = &quot;Relation_to_Island&quot;, y = &quot;% Features&quot;) +
  theme_cowplot(font_size = 12) -&gt; p1

dat %&gt;%
  mutate(Gene = UCSC_RefGene_Name != &quot;&quot;) %&gt;%
  ggplot(aes(x = Gene, 
           fill = Gene)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = &quot;Gene_associated&quot;, y = &quot;% Features&quot;) +
  theme_cowplot(font_size = 12) -&gt; p2

dat %&gt;%
  mutate(group = ifelse(is.na(group), &quot;Intergenic&quot;, group)) %&gt;%
  ggplot(aes(x = group, 
           fill = group)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = &quot;Position_in_Gene&quot;, y = &quot;% Features&quot;) +
  theme_cowplot(font_size = 12) -&gt; p3

dat %&gt;%
  mutate(DHS = DNase_Hypersensitivity_NAME != &quot;&quot;) %&gt;%
  ggplot(aes(x = DHS, 
           fill = DHS)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = &quot;DNase_Hypersensitivity_Site&quot;, y = &quot;% Features&quot;) +
  theme_cowplot(font_size = 12) -&gt; p4

((p1 | p2 ) /
  (p3 | p4)) &amp; 
  theme(legend.position = &quot;none&quot;,
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 8),
        axis.text = element_text(size = 6)) -&gt; anyLoci
anyLoci</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-7-1">
Past versions of unnamed-chunk-7-1.png
</button>
</p>
<div id="fig-unnamed-chunk-7-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/10147c01aaa38682abaf4f3694d1ce55fc634e06/docs/figure/estimateCellProportions.Rmd/unnamed-chunk-7-1.png" target="_blank">10147c0</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-27
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="characteristics-of-probes-selected-using-both" class="section level2">
<h2>Characteristics of probes selected using <em>“both”</em></h2>
<pre class="r"><code>sub &lt;- targets[targets$Sample_Group != &quot;Raw&quot;,]
tmp &lt;- mValsNoXY[rownames(mValsNoXY) %in% rownames(pBoth$coefEsts), 
                 colnames(mValsNoXY) %in% sub$Sample_ID]
tmpBoth &lt;- ann[match(rownames(tmp), ann$Name), -c(5:17,20,21,23,32:37)]

topBothFile &lt;- here(&quot;output&quot;,
                   glue(&quot;GO-Both.csv&quot;))

if(!file.exists(topBothFile)){
  gstBoth &lt;- gometh(sig.cpg = rownames(pBoth$coefEsts), 
                   all.cpg = rownames(mValsNoXY), 
                   anno = ann)
  topBoth &lt;- topGSA(gstBoth, number = 50)
  write.csv(topBoth, topBothFile)
  
} else {
  topBoth &lt;- read.csv(topBothFile, row.names = 1)
  
}

topGSA(topBoth) %&gt;% knitr::kable()</code></pre>
<table style="width:100%;">
<colgroup>
<col width="8%" />
<col width="7%" />
<col width="62%" />
<col width="3%" />
<col width="2%" />
<col width="7%" />
<col width="7%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">ONTOLOGY</th>
<th align="left">TERM</th>
<th align="right">N</th>
<th align="right">DE</th>
<th align="right">P.DE</th>
<th align="right">FDR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><a href="GO:0007159" class="uri">GO:0007159</a></td>
<td align="left">BP</td>
<td align="left">leukocyte cell-cell adhesion</td>
<td align="right">348</td>
<td align="right">17</td>
<td align="right">0.0000247</td>
<td align="right">0.5583832</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0042110" class="uri">GO:0042110</a></td>
<td align="left">BP</td>
<td align="left">T cell activation</td>
<td align="right">464</td>
<td align="right">19</td>
<td align="right">0.0001745</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0045321" class="uri">GO:0045321</a></td>
<td align="left">BP</td>
<td align="left">leukocyte activation</td>
<td align="right">1197</td>
<td align="right">34</td>
<td align="right">0.0002183</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0046649" class="uri">GO:0046649</a></td>
<td align="left">BP</td>
<td align="left">lymphocyte activation</td>
<td align="right">661</td>
<td align="right">23</td>
<td align="right">0.0002950</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:1903037" class="uri">GO:1903037</a></td>
<td align="left">BP</td>
<td align="left">regulation of leukocyte cell-cell adhesion</td>
<td align="right">314</td>
<td align="right">14</td>
<td align="right">0.0003422</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0006955" class="uri">GO:0006955</a></td>
<td align="left">BP</td>
<td align="left">immune response</td>
<td align="right">1912</td>
<td align="right">44</td>
<td align="right">0.0003422</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0001775" class="uri">GO:0001775</a></td>
<td align="left">BP</td>
<td align="left">cell activation</td>
<td align="right">1351</td>
<td align="right">37</td>
<td align="right">0.0004153</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0044272" class="uri">GO:0044272</a></td>
<td align="left">BP</td>
<td align="left">sulfur compound biosynthetic process</td>
<td align="right">181</td>
<td align="right">10</td>
<td align="right">0.0005641</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0042117" class="uri">GO:0042117</a></td>
<td align="left">BP</td>
<td align="left">monocyte activation</td>
<td align="right">10</td>
<td align="right">3</td>
<td align="right">0.0007333</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0002280" class="uri">GO:0002280</a></td>
<td align="left">BP</td>
<td align="left">monocyte activation involved in immune response</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="right">0.0007949</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0002682" class="uri">GO:0002682</a></td>
<td align="left">BP</td>
<td align="left">regulation of immune system process</td>
<td align="right">1458</td>
<td align="right">37</td>
<td align="right">0.0007958</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0002684" class="uri">GO:0002684</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of immune system process</td>
<td align="right">950</td>
<td align="right">27</td>
<td align="right">0.0008903</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0036037" class="uri">GO:0036037</a></td>
<td align="left">BP</td>
<td align="left">CD8-positive, alpha-beta T cell activation</td>
<td align="right">27</td>
<td align="right">4</td>
<td align="right">0.0010062</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:1903039" class="uri">GO:1903039</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of leukocyte cell-cell adhesion</td>
<td align="right">225</td>
<td align="right">11</td>
<td align="right">0.0010420</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0048010" class="uri">GO:0048010</a></td>
<td align="left">BP</td>
<td align="left">vascular endothelial growth factor receptor signaling pathway</td>
<td align="right">95</td>
<td align="right">8</td>
<td align="right">0.0010930</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0050776" class="uri">GO:0050776</a></td>
<td align="left">BP</td>
<td align="left">regulation of immune response</td>
<td align="right">868</td>
<td align="right">24</td>
<td align="right">0.0011057</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0033292" class="uri">GO:0033292</a></td>
<td align="left">BP</td>
<td align="left">T-tubule organization</td>
<td align="right">9</td>
<td align="right">3</td>
<td align="right">0.0012279</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0000506" class="uri">GO:0000506</a></td>
<td align="left">CC</td>
<td align="left">glycosylphosphatidylinositol-N-acetylglucosaminyltransferase (GPI-GnT) complex</td>
<td align="right">7</td>
<td align="right">2</td>
<td align="right">0.0012681</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0007256" class="uri">GO:0007256</a></td>
<td align="left">BP</td>
<td align="left">activation of JNKK activity</td>
<td align="right">10</td>
<td align="right">3</td>
<td align="right">0.0012843</td>
<td align="right">1.0000000</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0015961" class="uri">GO:0015961</a></td>
<td align="left">BP</td>
<td align="left">diadenosine polyphosphate catabolic process</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">0.0013242</td>
<td align="right">1.0000000</td>
</tr>
</tbody>
</table>
<pre class="r"><code>dat &lt;- tmpBoth
dat %&gt;% data.frame %&gt;%
  left_join(flatAnn, by = c(&quot;Name&quot; = &quot;cpg&quot;)) -&gt; dat

dat %&gt;%
ggplot(aes(x = Relation_to_Island, 
           fill = Relation_to_Island)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = &quot;Relation_to_Island&quot;, y = &quot;% Features&quot;) +
  theme_cowplot(font_size = 12) -&gt; p1

dat %&gt;%
  mutate(Gene = UCSC_RefGene_Name != &quot;&quot;) %&gt;%
  ggplot(aes(x = Gene, 
           fill = Gene)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = &quot;Gene_associated&quot;, y = &quot;% Features&quot;) +
  theme_cowplot(font_size = 12) -&gt; p2

dat %&gt;%
  mutate(group = ifelse(is.na(group), &quot;Intergenic&quot;, group)) %&gt;%
  ggplot(aes(x = group, 
           fill = group)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = &quot;Position_in_Gene&quot;, y = &quot;% Features&quot;) +
  theme_cowplot(font_size = 12) -&gt; p3

dat %&gt;%
  mutate(DHS = DNase_Hypersensitivity_NAME != &quot;&quot;) %&gt;%
  ggplot(aes(x = DHS, 
           fill = DHS)) +
  geom_bar(aes(y = (..count..)/sum(..count..)*100)) +
  labs(x = &quot;DNase_Hypersensitivity_Site&quot;, y = &quot;% Features&quot;) +
  theme_cowplot(font_size = 12) -&gt; p4

((p1 | p2 ) /
  (p3 | p4)) &amp; 
  theme(legend.position = &quot;none&quot;,
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 8),
        axis.text = element_text(size = 6)) -&gt; bothLoci
bothLoci</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;" /></p>
<div id="supplementary-figure-3" class="section level3">
<h3><strong>Supplementary Figure 3</strong></h3>
<pre class="r"><code>(wrap_elements(anyLoci + plot_annotation(title = &quot;Probe select = &#39;Any&#39;&quot;))  / 
   wrap_elements(bothLoci + plot_annotation(title = &quot;Probe select = &#39;Both&#39;&quot;))) + plot_annotation(tag_levels = &quot;A&quot;) &amp;
    theme(plot.tag = element_text(face = &#39;bold&#39;, size = 16))</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-10-1">
Past versions of unnamed-chunk-10-1.png
</button>
</p>
<div id="fig-unnamed-chunk-10-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/10147c01aaa38682abaf4f3694d1ce55fc634e06/docs/figure/estimateCellProportions.Rmd/unnamed-chunk-10-1.png" target="_blank">10147c0</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-27
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="characteristics-of-probes-that-are-the-same-for-any-and-both" class="section level2">
<h2>Characteristics of probes that are the same for <em>“any”</em> and <em>“both”</em></h2>
<pre class="r"><code>same &lt;- intersect(rownames(pAny$coefEsts), rownames(pBoth$coefEsts))
length(same)</code></pre>
<pre><code>[1] 221</code></pre>
<p>The number of probes that is the same using <em>any</em> and <em>both</em> is 221. This is 55.25% of the total number of cell type discriminating probes.</p>
<pre class="r"><code>tmp &lt;- mValsNoXY[rownames(mValsNoXY) %in% same,
                 colnames(mValsNoXY) %in% sub$Sample_ID]
tmpSame &lt;- ann[match(rownames(tmp), ann$Name), -c(5:17,20,21,23,32:37)]

topSameFile &lt;- here(&quot;output/GO-Same.csv&quot;)

if(!file.exists(topSameFile)){
  gstSame &lt;- gometh(sig.cpg = same, 
                   all.cpg = rownames(mValsNoXY), 
                   anno = ann)
  topSame &lt;- topGSA(gstSame, number = 50)
  write.csv(topSame, topSameFile)
  
} else {
  topSame &lt;- read.csv(topSameFile, row.names = 1)
  
}


topGSA(topSame) %&gt;% knitr::kable()</code></pre>
<table>
<colgroup>
<col width="9%" />
<col width="7%" />
<col width="65%" />
<col width="3%" />
<col width="2%" />
<col width="8%" />
<col width="3%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">ONTOLOGY</th>
<th align="left">TERM</th>
<th align="right">N</th>
<th align="right">DE</th>
<th align="right">P.DE</th>
<th align="right">FDR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><a href="GO:0042117" class="uri">GO:0042117</a></td>
<td align="left">BP</td>
<td align="left">monocyte activation</td>
<td align="right">10</td>
<td align="right">3</td>
<td align="right">0.0001583</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0033292" class="uri">GO:0033292</a></td>
<td align="left">BP</td>
<td align="left">T-tubule organization</td>
<td align="right">9</td>
<td align="right">3</td>
<td align="right">0.0002727</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0002280" class="uri">GO:0002280</a></td>
<td align="left">BP</td>
<td align="left">monocyte activation involved in immune response</td>
<td align="right">2</td>
<td align="right">2</td>
<td align="right">0.0002863</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0007159" class="uri">GO:0007159</a></td>
<td align="left">BP</td>
<td align="left">leukocyte cell-cell adhesion</td>
<td align="right">348</td>
<td align="right">11</td>
<td align="right">0.0002880</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0000506" class="uri">GO:0000506</a></td>
<td align="left">CC</td>
<td align="left">glycosylphosphatidylinositol-N-acetylglucosaminyltransferase (GPI-GnT) complex</td>
<td align="right">7</td>
<td align="right">2</td>
<td align="right">0.0004144</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0050765" class="uri">GO:0050765</a></td>
<td align="left">BP</td>
<td align="left">negative regulation of phagocytosis</td>
<td align="right">21</td>
<td align="right">3</td>
<td align="right">0.0005205</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:1903037" class="uri">GO:1903037</a></td>
<td align="left">BP</td>
<td align="left">regulation of leukocyte cell-cell adhesion</td>
<td align="right">314</td>
<td align="right">10</td>
<td align="right">0.0005293</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0047756" class="uri">GO:0047756</a></td>
<td align="left">MF</td>
<td align="left">chondroitin 4-sulfotransferase activity</td>
<td align="right">3</td>
<td align="right">2</td>
<td align="right">0.0005562</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0097470" class="uri">GO:0097470</a></td>
<td align="left">CC</td>
<td align="left">ribbon synapse</td>
<td align="right">11</td>
<td align="right">3</td>
<td align="right">0.0006711</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0010452" class="uri">GO:0010452</a></td>
<td align="left">BP</td>
<td align="left">histone H3-K36 methylation</td>
<td align="right">14</td>
<td align="right">3</td>
<td align="right">0.0006845</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0090023" class="uri">GO:0090023</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of neutrophil chemotaxis</td>
<td align="right">25</td>
<td align="right">3</td>
<td align="right">0.0010073</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0010793" class="uri">GO:0010793</a></td>
<td align="left">BP</td>
<td align="left">regulation of mRNA export from nucleus</td>
<td align="right">5</td>
<td align="right">2</td>
<td align="right">0.0011003</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0071624" class="uri">GO:0071624</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of granulocyte chemotaxis</td>
<td align="right">28</td>
<td align="right">3</td>
<td align="right">0.0011239</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0034481" class="uri">GO:0034481</a></td>
<td align="left">MF</td>
<td align="left">chondroitin sulfotransferase activity</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">0.0011489</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:2000197" class="uri">GO:2000197</a></td>
<td align="left">BP</td>
<td align="left">regulation of ribonucleoprotein complex localization</td>
<td align="right">6</td>
<td align="right">2</td>
<td align="right">0.0013055</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:1903039" class="uri">GO:1903039</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of leukocyte cell-cell adhesion</td>
<td align="right">225</td>
<td align="right">8</td>
<td align="right">0.0013234</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:1902624" class="uri">GO:1902624</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of neutrophil migration</td>
<td align="right">27</td>
<td align="right">3</td>
<td align="right">0.0014916</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0043378" class="uri">GO:0043378</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of CD8-positive, alpha-beta T cell differentiation</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">0.0014967</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0022409" class="uri">GO:0022409</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of cell-cell adhesion</td>
<td align="right">269</td>
<td align="right">9</td>
<td align="right">0.0015263</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0042060" class="uri">GO:0042060</a></td>
<td align="left">BP</td>
<td align="left">wound healing</td>
<td align="right">514</td>
<td align="right">14</td>
<td align="right">0.0016411</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
</div>
<div id="characteristics-of-probes-that-are-different-between-any-and-both" class="section level2">
<h2>Characteristics of probes that are different between <em>“any”</em> and <em>“both”</em></h2>
<pre class="r"><code>diff &lt;- c(rownames(pAny$coefEsts)[!rownames(pAny$coefEsts) %in% same],
          rownames(pBoth$coefEsts)[!rownames(pBoth$coefEsts) %in% same])
length(diff)</code></pre>
<pre><code>[1] 358</code></pre>
<p>The number of probes that is different using <em>any</em> and <em>both</em> is 358. This is 89.5% of the total number of cell type discriminating probes.</p>
<pre class="r"><code>tmp &lt;- mValsNoXY[rownames(mValsNoXY) %in% diff,
                 colnames(mValsNoXY) %in% sub$Sample_ID]
tmpDiff &lt;- ann[match(rownames(tmp), ann$Name), -c(5:17,20,21,23,32:37)]

topDiffFile &lt;- here(&quot;output/GO-Diff.csv&quot;)

if(!file.exists(topDiffFile)){
  gstDiff &lt;- gometh(sig.cpg = diff, 
                   all.cpg = rownames(mValsNoXY), 
                   anno = ann)
  topDiff &lt;- topGSA(gstDiff, number = 50)
  write.csv(topDiff, topDiffFile)
  
} else {
  topDiff &lt;- read.csv(topDiffFile, row.names = 1)
  
}


topGSA(topDiff) %&gt;% knitr::kable()</code></pre>
<table>
<colgroup>
<col width="9%" />
<col width="7%" />
<col width="60%" />
<col width="4%" />
<col width="2%" />
<col width="8%" />
<col width="8%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">ONTOLOGY</th>
<th align="left">TERM</th>
<th align="right">N</th>
<th align="right">DE</th>
<th align="right">P.DE</th>
<th align="right">FDR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><a href="GO:0004674" class="uri">GO:0004674</a></td>
<td align="left">MF</td>
<td align="left">protein serine/threonine kinase activity</td>
<td align="right">412</td>
<td align="right">21</td>
<td align="right">0.0000145</td>
<td align="right">0.2751161</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0006955" class="uri">GO:0006955</a></td>
<td align="left">BP</td>
<td align="left">immune response</td>
<td align="right">1912</td>
<td align="right">41</td>
<td align="right">0.0000243</td>
<td align="right">0.2751161</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0046328" class="uri">GO:0046328</a></td>
<td align="left">BP</td>
<td align="left">regulation of JNK cascade</td>
<td align="right">177</td>
<td align="right">12</td>
<td align="right">0.0000507</td>
<td align="right">0.2842184</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0018210" class="uri">GO:0018210</a></td>
<td align="left">BP</td>
<td align="left">peptidyl-threonine modification</td>
<td align="right">123</td>
<td align="right">10</td>
<td align="right">0.0000672</td>
<td align="right">0.2842184</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0046330" class="uri">GO:0046330</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of JNK cascade</td>
<td align="right">131</td>
<td align="right">10</td>
<td align="right">0.0000751</td>
<td align="right">0.2842184</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0043506" class="uri">GO:0043506</a></td>
<td align="left">BP</td>
<td align="left">regulation of JUN kinase activity</td>
<td align="right">85</td>
<td align="right">8</td>
<td align="right">0.0000871</td>
<td align="right">0.2842184</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0046649" class="uri">GO:0046649</a></td>
<td align="left">BP</td>
<td align="left">lymphocyte activation</td>
<td align="right">661</td>
<td align="right">21</td>
<td align="right">0.0001081</td>
<td align="right">0.2842184</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0048584" class="uri">GO:0048584</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of response to stimulus</td>
<td align="right">2258</td>
<td align="right">51</td>
<td align="right">0.0001149</td>
<td align="right">0.2842184</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0045321" class="uri">GO:0045321</a></td>
<td align="left">BP</td>
<td align="left">leukocyte activation</td>
<td align="right">1197</td>
<td align="right">30</td>
<td align="right">0.0001177</td>
<td align="right">0.2842184</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0007254" class="uri">GO:0007254</a></td>
<td align="left">BP</td>
<td align="left">JNK cascade</td>
<td align="right">201</td>
<td align="right">12</td>
<td align="right">0.0001341</td>
<td align="right">0.2842184</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0080135" class="uri">GO:0080135</a></td>
<td align="left">BP</td>
<td align="left">regulation of cellular response to stress</td>
<td align="right">740</td>
<td align="right">24</td>
<td align="right">0.0001382</td>
<td align="right">0.2842184</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0018107" class="uri">GO:0018107</a></td>
<td align="left">BP</td>
<td align="left">peptidyl-threonine phosphorylation</td>
<td align="right">114</td>
<td align="right">9</td>
<td align="right">0.0001825</td>
<td align="right">0.3088682</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0032874" class="uri">GO:0032874</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of stress-activated MAPK cascade</td>
<td align="right">162</td>
<td align="right">10</td>
<td align="right">0.0002110</td>
<td align="right">0.3088682</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0018209" class="uri">GO:0018209</a></td>
<td align="left">BP</td>
<td align="left">peptidyl-serine modification</td>
<td align="right">316</td>
<td align="right">15</td>
<td align="right">0.0002165</td>
<td align="right">0.3088682</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0043507" class="uri">GO:0043507</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of JUN kinase activity</td>
<td align="right">70</td>
<td align="right">7</td>
<td align="right">0.0002184</td>
<td align="right">0.3088682</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0034097" class="uri">GO:0034097</a></td>
<td align="left">BP</td>
<td align="left">response to cytokine</td>
<td align="right">1166</td>
<td align="right">28</td>
<td align="right">0.0002292</td>
<td align="right">0.3088682</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0032872" class="uri">GO:0032872</a></td>
<td align="left">BP</td>
<td align="left">regulation of stress-activated MAPK cascade</td>
<td align="right">226</td>
<td align="right">12</td>
<td align="right">0.0002321</td>
<td align="right">0.3088682</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0070304" class="uri">GO:0070304</a></td>
<td align="left">BP</td>
<td align="left">positive regulation of stress-activated protein kinase signaling cascade</td>
<td align="right">164</td>
<td align="right">10</td>
<td align="right">0.0002533</td>
<td align="right">0.3151636</td>
</tr>
<tr class="odd">
<td align="left"><a href="GO:0034351" class="uri">GO:0034351</a></td>
<td align="left">BP</td>
<td align="left">negative regulation of glial cell apoptotic process</td>
<td align="right">7</td>
<td align="right">3</td>
<td align="right">0.0002750</td>
<td align="right">0.3151636</td>
</tr>
<tr class="even">
<td align="left"><a href="GO:0070302" class="uri">GO:0070302</a></td>
<td align="left">BP</td>
<td align="left">regulation of stress-activated protein kinase signaling cascade</td>
<td align="right">229</td>
<td align="right">12</td>
<td align="right">0.0002786</td>
<td align="right">0.3151636</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="estimate-cell-type-proportions-of-raw-bal-samples" class="section level1">
<h1>Estimate cell type proportions of raw BAL samples</h1>
<div id="artificial-mixture" class="section level2">
<h2>Artificial mixture</h2>
<p>We will use blood immune cell mixtures with known cell type proportions published by Salas et al. 2018 to test the accuracy of cell type proportion estimates derived using our reference library.</p>
<pre class="r"><code>hub &lt;- ExperimentHub()  </code></pre>
<pre><code>snapshotDate(): 2020-10-27</code></pre>
<pre class="r"><code>query(hub, &quot;FlowSorted.Blood.EPIC&quot;) </code></pre>
<pre><code>ExperimentHub with 1 record
# snapshotDate(): 2020-10-27
# names(): EH1136
# package(): FlowSorted.Blood.EPIC
# $dataprovider: GEO
# $species: Homo sapiens
# $rdataclass: RGChannelSet
# $rdatadateadded: 2018-04-20
# $title: FlowSorted.Blood.EPIC: Illumina Human Methylation data from EPIC o...
# $description: The FlowSorted.Blood.EPIC package contains Illumina HumanMet...
# $taxonomyid: 9606
# $genome: hg19
# $sourcetype: tar.gz
# $sourceurl: https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE110554
# $sourcesize: NA
# $tags: c(&quot;ExperimentData&quot;, &quot;Homo_sapiens_Data&quot;, &quot;Tissue&quot;,
#   &quot;MicroarrayData&quot;, &quot;Genome&quot;, &quot;TissueMicroarrayData&quot;,
#   &quot;MethylationArrayData&quot;) 
# retrieve record with &#39;object[[&quot;EH1136&quot;]]&#39; </code></pre>
<pre class="r"><code>FlowSorted.Blood.EPIC &lt;- hub[[&quot;EH1136&quot;]]</code></pre>
<pre><code>see ?FlowSorted.Blood.EPIC and browseVignettes(&#39;FlowSorted.Blood.EPIC&#39;) for documentation</code></pre>
<pre><code>loading from cache</code></pre>
<pre class="r"><code># separate the reference from the testing dataset  
RGsetTargets &lt;- FlowSorted.Blood.EPIC[,FlowSorted.Blood.EPIC$CellType == &quot;MIX&quot;]
mixReal &lt;- as.matrix(colData(RGsetTargets)[,12:17])/100</code></pre>
<pre class="r"><code>mixDat &lt;- melt(mixReal)
colnames(mixDat) &lt;- c(&quot;sample&quot;,&quot;cell&quot;,&quot;proportion&quot;)

p &lt;- ggplot(mixDat, aes(sample)) + 
  geom_bar(aes(fill = cell, weight=proportion)) +
  scale_x_discrete(breaks = waiver(), labels=1:nrow(mixReal)) +
  ggtitle(&quot;Artificially created cell mixtures&quot;) +
  labs(y = &quot;Proportion&quot;, x = &quot;Mixture&quot;, fill = &quot;Cell type&quot;)
p</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-16-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-16-1">
Past versions of unnamed-chunk-16-1.png
</button>
</p>
<div id="fig-unnamed-chunk-16-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/a90dc68a9e8608ef7e5fe16f02059495870f6fd6/docs/figure/estimateCellProportions.Rmd/unnamed-chunk-16-1.png" target="_blank">a90dc68</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-28
</td>
</tr>
<tr>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/10147c01aaa38682abaf4f3694d1ce55fc634e06/docs/figure/estimateCellProportions.Rmd/unnamed-chunk-16-1.png" target="_blank">10147c0</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-27
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We have not sorted our BAL lymphocytes into B cells, T cells and NK cells, so the “true” lymphocyte value we will compare to is the sum of the proportions of those cells in the artificial mixture.</p>
<pre class="r"><code>mixSum &lt;- data.frame(mixReal[,5:6], Lymph = rowSums(mixReal[,1:4]))
mixSumDat &lt;- melt(as.matrix(mixSum))
colnames(mixSumDat) &lt;- c(&quot;sample&quot;,&quot;cell&quot;,&quot;proportion&quot;)

p &lt;- ggplot(mixSumDat, aes(sample)) + 
  geom_bar(aes(fill = cell, weight = proportion)) +
    scale_x_discrete(breaks = waiver(), labels = 1:nrow(mixReal)) +
    ggtitle(&quot;Artificially created cell mixtures&quot;) +
  labs(y = &quot;Proportion&quot;, x = &quot;Mixture&quot;, fill = &quot;Cell type&quot;)
p</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-17-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-17-1">
Past versions of unnamed-chunk-17-1.png
</button>
</p>
<div id="fig-unnamed-chunk-17-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/10147c01aaa38682abaf4f3694d1ce55fc634e06/docs/figure/estimateCellProportions.Rmd/unnamed-chunk-17-1.png" target="_blank">10147c0</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-27
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Estimate cell type proportions in artificial mixture using <em>both</em> option.</p>
<pre class="r"><code>lavageRef &lt;- rgSet[,cells]
colData(lavageRef)$CellType &lt;- colData(lavageRef)$Sample_Group
mixEstBoth &lt;- estimateCellCounts2Mod(rgSet = RGsetTargets,
                                  compositeCellType = &quot;Lavage&quot;,
                                  processMethod = &quot;preprocessQuantile&quot;,
                                  probeSelect = &quot;both&quot;,
                                  cellTypes = unique(targets$Sample_Group[cells]),
                                  referencePlatform =
                                    &quot;IlluminaHumanMethylationEPIC&quot;,
                                  referenceset = &quot;lavageRef&quot;,
                                  IDOLOptimizedCpGs = NULL,
                                  returnAll = FALSE,
                                  meanPlot = FALSE,
                                  keepProbes = rownames(mValsNoXY))</code></pre>
<pre><code>[estimateCellCounts2] Combining user data with reference (flow sorted) data.</code></pre>
<pre><code>Warning in DataFrame(sampleNames = c(colnames(rgSet),
colnames(referenceRGset)), : &#39;stringsAsFactors&#39; is ignored</code></pre>
<pre><code>[estimateCellCounts2] Processing user and reference data together.</code></pre>
<pre><code>[preprocessQuantile] Mapping to genome.</code></pre>
<pre><code>Warning in .getSex(CN = CN, xIndex = xIndex, yIndex = yIndex, cutoff = cutoff):
An inconsistency was encountered while determining sex. One possibility is
that only one sex is present. We recommend further checks, for example with the
plotSex function.</code></pre>
<pre><code>[preprocessQuantile] Fixing outliers.</code></pre>
<pre><code>[preprocessQuantile] Quantile normalizing.</code></pre>
<pre><code>[estimateCellCounts2] Picking probes for composition estimation.</code></pre>
<pre><code>[estimateCellCounts2] Estimating composition.</code></pre>
<pre class="r"><code>mixEstBoth$counts</code></pre>
<pre><code>                    EpithelialCell    Macrophage Granulocyte Lymphocyte
201868590193_R01C01   0.000000e+00  9.126279e-02   0.3616930  0.5660512
201868590243_R02C01   0.000000e+00 -4.269868e-20   0.7388455  0.2612947
201868590267_R01C01   0.000000e+00  1.915281e-02   0.7804746  0.2008515
201868590267_R05C01   0.000000e+00 -3.189628e-20   0.6796117  0.3189449
201869680008_R01C01   2.404706e-04  8.807077e-02   0.2596974  0.6657974
201869680008_R03C01  -1.179253e-18  0.000000e+00   0.7136450  0.2817510
201869680008_R06C01   0.000000e+00  7.828989e-02   0.3636083  0.5640165
201869680030_R03C01   0.000000e+00 -4.890270e-20   0.7014649  0.3042240
201869680030_R07C01   0.000000e+00 -5.957902e-20   0.7772578  0.2200175
201870610056_R01C01   0.000000e+00  3.605620e-02   0.2957907  0.6859857
201870610056_R03C01   0.000000e+00  1.131711e-01   0.2196631  0.6858875
201870610111_R03C01   0.000000e+00  1.024043e-01   0.4025289  0.5060127</code></pre>
<pre class="r"><code>mixBoth &lt;- reshape2::melt(mixEstBoth$counts)
colnames(mixBoth) &lt;- c(&quot;sample&quot;,&quot;cell&quot;,&quot;proportion&quot;)

p1 &lt;- ggplot(mixBoth, aes(x = sample, fill = cell)) + 
  geom_bar(aes(weight = proportion)) +
  ggtitle(&quot;Cell type proportion estimates&quot;, 
          subtitle = &quot;Probe selection: Both&quot;) +
  labs(x = &quot;Sample&quot;, y = &quot;Proportion&quot;, fill = &quot;Cell type&quot;) + 
  scale_x_discrete(breaks = waiver(), labels = 1:nrow(mixReal)) +
  scale_fill_manual(values = pal)
p1</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-19-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-19-1">
Past versions of unnamed-chunk-19-1.png
</button>
</p>
<div id="fig-unnamed-chunk-19-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/10147c01aaa38682abaf4f3694d1ce55fc634e06/docs/figure/estimateCellProportions.Rmd/unnamed-chunk-19-1.png" target="_blank">10147c0</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-27
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>(p | p1) + 
  plot_layout(guides = &quot;collect&quot;) &amp; 
  theme(legend.position = &quot;bottom&quot;,
        legend.box = &quot;vertical&quot;)</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-20-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Estimate cell type proportions in artificial mixture using <em>“any”</em> option.</p>
<pre class="r"><code>mixEstAny &lt;- estimateCellCounts2Mod(rgSet = RGsetTargets, 
                                 compositeCellType = &quot;Lavage&quot;,   
                                processMethod = &quot;preprocessQuantile&quot;,  
                                probeSelect = &quot;any&quot;,  
                                cellTypes = unique(targets$Sample_Group[cells]),  
                                referencePlatform =   
                                &quot;IlluminaHumanMethylationEPIC&quot;,  
                                referenceset = &quot;lavageRef&quot;,  
                                IDOLOptimizedCpGs = NULL,   
                                returnAll = FALSE,
                                meanPlot = FALSE,
                                keepProbes = rownames(mValsNoXY))</code></pre>
<pre><code>[estimateCellCounts2] Combining user data with reference (flow sorted) data.</code></pre>
<pre><code>Warning in DataFrame(sampleNames = c(colnames(rgSet),
colnames(referenceRGset)), : &#39;stringsAsFactors&#39; is ignored</code></pre>
<pre><code>[estimateCellCounts2] Processing user and reference data together.</code></pre>
<pre><code>[preprocessQuantile] Mapping to genome.</code></pre>
<pre><code>Warning in .getSex(CN = CN, xIndex = xIndex, yIndex = yIndex, cutoff = cutoff):
An inconsistency was encountered while determining sex. One possibility is
that only one sex is present. We recommend further checks, for example with the
plotSex function.</code></pre>
<pre><code>[preprocessQuantile] Fixing outliers.</code></pre>
<pre><code>[preprocessQuantile] Quantile normalizing.</code></pre>
<pre><code>[estimateCellCounts2] Picking probes for composition estimation.</code></pre>
<pre><code>[estimateCellCounts2] Estimating composition.</code></pre>
<pre class="r"><code>mixEstAny$counts</code></pre>
<pre><code>                    EpithelialCell  Macrophage Granulocyte Lymphocyte
201868590193_R01C01   0.000000e+00 0.147918242   0.3053763  0.5746209
201868590243_R02C01   0.000000e+00 0.006390512   0.7234165  0.2676621
201868590267_R01C01   1.734723e-18 0.048680044   0.7572886  0.2027038
201868590267_R05C01   0.000000e+00 0.019133044   0.6613300  0.3209722
201869680008_R01C01   0.000000e+00 0.162845311   0.2165590  0.6574659
201869680008_R03C01   0.000000e+00 0.012635790   0.7008658  0.2832374
201869680008_R06C01   0.000000e+00 0.135170214   0.3300484  0.5587240
201869680030_R03C01  -1.734723e-18 0.004996861   0.6784126  0.3156032
201869680030_R07C01   0.000000e+00 0.004925952   0.7677886  0.2238971
201870610056_R01C01   0.000000e+00 0.079967402   0.2388535  0.6965378
201870610056_R03C01   0.000000e+00 0.184260959   0.1537695  0.6933920
201870610111_R03C01   0.000000e+00 0.166083551   0.3528550  0.5060989</code></pre>
<pre class="r"><code>mixAny &lt;- reshape2::melt(mixEstAny$counts)
colnames(mixAny) &lt;- c(&quot;sample&quot;,&quot;cell&quot;,&quot;proportion&quot;)

p2 &lt;- ggplot(mixAny, aes(x = sample, fill = cell)) + 
  geom_bar(aes(weight = proportion)) +
  ggtitle(&quot;Cell type proportion estimates&quot;, 
          subtitle = &quot;Probe selection: Any&quot;) +
  labs(x = &quot;Sample&quot;, y = &quot;Proportion&quot;, fill = &quot;Cell type&quot;) + 
  scale_x_discrete(breaks = waiver(), labels = 1:nrow(mixReal)) +
  scale_fill_manual(values = pal)
p2</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-22-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-22-1">
Past versions of unnamed-chunk-22-1.png
</button>
</p>
<div id="fig-unnamed-chunk-22-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/10147c01aaa38682abaf4f3694d1ce55fc634e06/docs/figure/estimateCellProportions.Rmd/unnamed-chunk-22-1.png" target="_blank">10147c0</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-27
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>(p | p2) + 
  plot_layout(guides = &quot;collect&quot;) &amp; 
  theme(legend.position = &quot;bottom&quot;,
        legend.box = &quot;vertical&quot;)</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-23-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-23-1">
Past versions of unnamed-chunk-23-1.png
</button>
</p>
<div id="fig-unnamed-chunk-23-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/10147c01aaa38682abaf4f3694d1ce55fc634e06/docs/figure/estimateCellProportions.Rmd/unnamed-chunk-23-1.png" target="_blank">10147c0</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-27
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>mixSumDat$est &lt;- &quot;Truth&quot;
mixSumDat$num &lt;- rownames(mixSumDat)
mixBoth$est &lt;- &quot;Est. (both)&quot;
mixBoth$num &lt;- rownames(mixBoth)
mixAny$est &lt;- &quot;Est. (any)&quot;
mixAny$num &lt;- rownames(mixAny)

fullDat &lt;- rbind(mixSumDat, mixBoth, mixAny)
fullDat$cell &lt;- fct_recode(fullDat$cell, 
                           Lymphocyte = &quot;Lymph&quot;, 
                           Granulocyte = &quot;Neu&quot;, 
                           Macrophage = &quot;Mono&quot;)
fullDat &lt;- fullDat[fullDat$cell != &quot;EpithelialCell&quot;,]
fullDat$cell &lt;- fct_drop(fullDat$cell)

p1a &lt;- ggplot(fullDat, aes(x = sample, y = proportion, fill = est)) + 
  geom_bar(stat = &quot;identity&quot;, position = &quot;dodge&quot;) +
  facet_grid(.~ cell, scales = &quot;free_x&quot;) +
  labs(x = &quot;Mixture&quot;, y = &quot;Proportion&quot;, fill = &quot;Source&quot;) + 
  scale_x_discrete(breaks = waiver(), labels = 1:nrow(mixReal)) +
  theme_cowplot() +
  theme(axis.text.x = element_text(size = 8)) 

p1a</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-24-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-24-1">
Past versions of unnamed-chunk-24-1.png
</button>
</p>
<div id="fig-unnamed-chunk-24-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/215068501d56b6ac71bcab25e0a4cfc2141f4139/docs/figure/estimateCellProportions.Rmd/unnamed-chunk-24-1.png" target="_blank">2150685</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-10-01
</td>
</tr>
<tr>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/a90dc68a9e8608ef7e5fe16f02059495870f6fd6/docs/figure/estimateCellProportions.Rmd/unnamed-chunk-24-1.png" target="_blank">a90dc68</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-28
</td>
</tr>
<tr>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/10147c01aaa38682abaf4f3694d1ce55fc634e06/docs/figure/estimateCellProportions.Rmd/unnamed-chunk-24-1.png" target="_blank">10147c0</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-09-27
</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can see that the estimates of granulocyte and lymphocute proportions made using our BAL reference panel are highly correlated with the true proportions regardless of how the discrimination probe set is chosen. Although there is evidence of slight overestimation of granulocytes in some samples. This discrepancy is likely due to the fact that the mixture samples contain only neutrophils whereas our reference panel contains all granulocyte types. However, despite this shortcoming, the cell type proportion estimates are still very accurate. This suggests that our BAL reference panel, in combination with the Houseman algorithm, should be able to accurately estimate cell type proportions in our patient BAL samples.</p>
<pre class="r"><code>dat1 &lt;- tibble(x = rowMeans(cbind(mixSum[,&quot;Neu&quot;], 
                                 mixEstAny$counts[,&quot;Granulocyte&quot;])),
              y = (mixSum[,&quot;Neu&quot;] - mixEstAny$counts[,&quot;Granulocyte&quot;])) %&gt;%
  mutate(Mixture = factor(1:n()))
c1 &lt;- cor.test(mixSum[,&#39;Neu&#39;], mixEstAny$counts[,&#39;Granulocyte&#39;])
mse1 &lt;- signif(mean(dat1$y^2), 2)
p1 &lt;- ggplot(dat1, aes(x = x, y = y)) +
  geom_text(label = 1:nrow(mixSum), size = 2.5) +
  #geom_point(aes(color = Mixture)) +
  geom_hline(yintercept = 0, linetype = &quot;dashed&quot;, colour = &quot;red&quot;) +
  labs(x = &quot;Mean&quot;, y = &quot;Difference (Truth - Estimate)&quot;) +
  coord_cartesian(ylim = c(-0.2, 0.2)) +
  ggtitle(&quot;Granulocytes&quot;, subtitle = &quot;Probe select = &#39;Any&#39;&quot;) +
  theme_cowplot(font_size = 12) +
  annotate(&quot;text&quot;, x = 0.1, y = 0.2, hjust = 0, size = 3,
           label = glue::glue(&quot;MSE = {mse1}&quot;))
           #label = glue::glue(&quot;Pearson correlation = {round(c1$estimate, 4)}
           #                   p-value = {signif(c1$p.value, 4)}&quot;))

dat2 &lt;- tibble(x = rowMeans(cbind(mixSum[,&quot;Lymph&quot;], 
                                 mixEstAny$counts[,&quot;Lymphocyte&quot;])),
              y = (mixSum[,&quot;Lymph&quot;] - mixEstAny$counts[,&quot;Lymphocyte&quot;])) %&gt;%
  mutate(Mixture = factor(1:n()))
c2 &lt;- cor.test(mixSum[,&#39;Lymph&#39;], mixEstAny$counts[,&#39;Lymphocyte&#39;])
mse2 &lt;- signif(mean(dat2$y^2), 2)
p2 &lt;- ggplot(dat2, aes(x = x, y = y)) +
  geom_text(label = 1:nrow(mixSum), size = 2.5) +
  #geom_point(aes(color = Mixture)) +
  geom_hline(yintercept = 0, linetype = &quot;dashed&quot;, colour = &quot;red&quot;) +
  labs(x = &quot;Mean&quot;, y = &quot;Difference (Truth - Estimate)&quot;) +
  coord_cartesian(ylim = c(-0.2, 0.2)) +
  ggtitle(&quot;Lymphocytes&quot;, subtitle = &quot;Probe select = &#39;Any&#39;&quot;) +
  theme_cowplot(font_size = 12) +
  annotate(&quot;text&quot;, x = 0.1, y = 0.2, hjust = 0, size = 3,
           label = glue::glue(&quot;MSE = {mse2}&quot;))
           #label = glue::glue(&quot;Pearson correlation = {round(c2$estimate, 4)}
            #                   p-value = {signif(c2$p.value, 4)}&quot;))

dat3 &lt;- tibble(x = rowMeans(cbind(mixSum[,&quot;Neu&quot;], 
                                 mixEstBoth$counts[,&quot;Granulocyte&quot;])),
              y = (mixSum[,&quot;Neu&quot;] - mixEstBoth$counts[,&quot;Granulocyte&quot;])) %&gt;%
  mutate(Mixture = factor(1:n()))
c3 &lt;- cor.test(mixSum[,&#39;Neu&#39;], mixEstBoth$counts[,&#39;Granulocyte&#39;])
mse3 &lt;- signif(mean(dat3$y^2), 2)
p3 &lt;- ggplot(dat3, aes(x = x, y = y)) +
  geom_text(label = 1:nrow(mixSum), size = 2.5) +
  #geom_point(aes(color = Mixture)) +
  geom_hline(yintercept = 0, linetype = &quot;dashed&quot;, colour = &quot;red&quot;) +
  labs(x = &quot;Mean&quot;, y = &quot;Difference (Truth - Estimate)&quot;) +
  coord_cartesian(ylim = c(-0.2, 0.2)) +
  ggtitle(&quot;Granulocytes&quot;, subtitle = &quot;Probe select = &#39;Both&#39;&quot;) +
  theme_cowplot(font_size = 12) +
  annotate(&quot;text&quot;, x = 0.1, y = 0.2, hjust = 0, size = 3,
           label = glue::glue(&quot;MSE = {mse3}&quot;))
           #label = glue::glue(&quot;Pearson correlation = {round(c3$estimate, 4)}
            #                   p-value = {signif(c3$p.value, 4)}&quot;))

dat4 &lt;- tibble(x = rowMeans(cbind(mixSum[,&quot;Lymph&quot;], 
                                 mixEstBoth$counts[,&quot;Lymphocyte&quot;])),
              y = (mixSum[,&quot;Lymph&quot;] - mixEstBoth$counts[,&quot;Lymphocyte&quot;])) %&gt;%
  mutate(Mixture = factor(1:n()))
c4 &lt;- cor.test(mixSum[,&#39;Lymph&#39;], mixEstBoth$counts[,&#39;Lymphocyte&#39;])
mse4 &lt;- signif(mean(dat4$y^2),2)
p4 &lt;- ggplot(dat4, aes(x = x, y = y)) +
  geom_text(label = 1:nrow(mixSum), size = 2.5) +
  #geom_point(aes(color = Mixture)) +
  geom_hline(yintercept = 0, linetype = &quot;dashed&quot;, colour = &quot;red&quot;) +
  labs(x = &quot;Mean&quot;, y = &quot;Difference (Truth - Estimate)&quot;) +
  coord_cartesian(ylim = c(-0.2, 0.2)) +
  ggtitle(&quot;Lymphocytes&quot;, subtitle = &quot;Probe select = &#39;Both&#39;&quot;) +
  theme_cowplot(font_size = 12) +
  annotate(&quot;text&quot;, x = 0.1, y = 0.2, hjust = 0, size = 3,
           label = glue::glue(&quot;MSE = {mse4}&quot;))
           #label = glue::glue(&quot;Pearson correlation = {round(c4$estimate, 4)}
            #                   p-value = {signif(c4$p.value, 4)}&quot;))

((p1 | p2) / (p3 | p4)) + 
  plot_layout(guides = &quot;collect&quot;) +
  plot_annotation(tag_levels = &quot;A&quot;) &amp;
    theme(plot.tag = element_text(face = &#39;bold&#39;, size = 16),
          legend.position = &quot;bottom&quot;)</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-25-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-unnamed-chunk-25-1">
Past versions of unnamed-chunk-25-1.png
</button>
</p>
<div id="fig-unnamed-chunk-25-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<a href="https://atlassian.petermac.org.au/bitbucket/scm/os/paed-bal-meth-ref/blob/215068501d56b6ac71bcab25e0a4cfc2141f4139/docs/figure/estimateCellProportions.Rmd/unnamed-chunk-25-1.png" target="_blank">2150685</a>
</td>
<td>
Jovana Maksimovic
</td>
<td>
2021-10-01
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="figure-4" class="section level3">
<h3><strong>Figure 4</strong></h3>
<pre class="r"><code>((p1a + scale_fill_brewer(palette = &quot;Set2&quot;) + 
    theme(legend.position = &quot;bottom&quot;,
              legend.text = element_text(size = 8),
              legend.title = element_text(size = 9))) / 
   (p1 | p2) / (p3 | p4)) + 
  plot_annotation(tag_levels = &quot;A&quot;) &amp;
    theme(plot.tag = element_text(face = &#39;bold&#39;, size = 16))</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-26-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>If we look at MDS plots of the mixture data, as well as of the known cell type proportions, we can see that the primary source of variation is the proportion of neutrophils vs. lymphoctes. This overlaps with the the samples where we are seeing slight over estimation of granulocyte proportions.</p>
<pre class="r"><code>mSetTargets &lt;- preprocessRaw(RGsetTargets)
mValsTargets &lt;- getM(mSetTargets)

mds &lt;- plotMDS(mValsTargets, top = 1000, gene.selection = &quot;common&quot;, 
               plot = FALSE)
dat &lt;- tibble(x = mds$x, y = mds$y, sample = 1:12)
p1 &lt;- ggplot(dat, aes(x = x, y = y)) +
  geom_text(aes(label = sample)) +
  labs(x = &quot;Principal Component 1&quot;, y = &quot;Principal Component 2&quot;)

mds &lt;- plotMDS(mixReal, top = 1000, gene.selection = &quot;common&quot;, 
               plot = FALSE)
dat &lt;- tibble(x = mds$x, y = mds$y, sample = colnames(mixReal))
p2 &lt;- ggplot(dat, aes(x = x, y = y)) +
  geom_text(aes(label = sample)) +
  labs(x = &quot;Principal Component 1&quot;, y = &quot;Principal Component 2&quot;)

(p1 | p2)</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-27-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="raw-bal-samples" class="section level2">
<h2>Raw BAL samples</h2>
<p>We can estimate the proportions of cell types in each of our raw BAL samples using our reference panel. To select the most informative cell type probes from our reference panel we can either set the ’<code>probeSelect</code> paremeter to <em>both</em>, which selects an equal number (50) of probes (with F-stat p-value &lt; 1E-8) with the greatest magnitude of effect from the hyper and hypo methylated sides; or <em>any</em>, which selects the 100 probes (with F-stat p-value &lt; 1E-8) with the greatest magnitude of difference regardless of direction of effect.</p>
<p>Get estimates for proportion of each cell type using the <em>any</em> option.</p>
<pre class="r"><code>patientSamps &lt;- rgSet[, targets$Sample_Group == &quot;Raw&quot;]
sampleNames(patientSamps) &lt;- targets$Sample_source[targets$Sample_Group == &quot;Raw&quot;]
cellEstAny &lt;- estimateCellCounts2Mod(rgSet = patientSamps, 
                                  compositeCellType = &quot;Lavage&quot;,   
                                  processMethod = &quot;preprocessQuantile&quot;,  
                                  probeSelect = &quot;any&quot;,  
                                  cellTypes = unique(targets$Sample_Group[cells]),  
                                  referencePlatform = 
                                    &quot;IlluminaHumanMethylationEPIC&quot;,  
                                  referenceset = &quot;lavageRef&quot;,  
                                  IDOLOptimizedCpGs = NULL,   
                                  returnAll = TRUE,
                                  meanPlot = FALSE,
                                  keepProbes = rownames(mValsNoXY))
cellEstAny$counts</code></pre>
<pre><code>     EpithelialCell Macrophage Granulocyte Lymphocyte
CF4      0.09793734 0.66758315   0.1464392 0.12014193
CF1      0.09032793 0.01217868   0.8898728 0.01503895
CF3      0.21500314 0.37264030   0.2236391 0.22976338
CF2      0.11447882 0.30504955   0.4358487 0.20458003
CF5      0.05676325 0.51112862   0.3566726 0.11446217
CTRL     0.12935134 0.14927553   0.5845740 0.18375917</code></pre>
<pre class="r"><code>estAny &lt;- reshape2::melt(cellEstAny$counts)
colnames(estAny) &lt;- c(&quot;sample&quot;,&quot;cell&quot;,&quot;proportion&quot;)

p1 &lt;- ggplot(estAny, aes(x = sample, fill = cell)) + 
  geom_bar(aes(weight = proportion)) +
  ggtitle(&quot;Cell type proportion estimates&quot;, 
          subtitle = &quot;Probe selection: Any&quot;) +
  labs(x = &quot;Sample&quot;, y = &quot;Proportion&quot;, fill = &quot;Cell type&quot;) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
        legend.position = &quot;bottom&quot;) +
  scale_fill_manual(values = pal)
p1</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-29-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Get estimates for proportion of each cell type using the <em>“both”</em> option.</p>
<pre class="r"><code>cellEstBoth &lt;- estimateCellCounts2Mod(rgSet = patientSamps, 
                                   compositeCellType = &quot;Lavage&quot;,   
                                   processMethod = &quot;preprocessQuantile&quot;,  
                                   probeSelect = &quot;both&quot;,  
                                   cellTypes = unique(targets$Sample_Group[cells]),  
                                   referencePlatform =   
                                     &quot;IlluminaHumanMethylationEPIC&quot;,  
                                   referenceset = &quot;lavageRef&quot;,  
                                   IDOLOptimizedCpGs = NULL,   
                                   returnAll = TRUE,
                                   meanPlot = FALSE,
                                   keepProbes = rownames(mValsNoXY))
cellEstBoth$counts</code></pre>
<pre><code>     EpithelialCell  Macrophage Granulocyte Lymphocyte
CF4      0.10056117 0.687692615   0.1564780 0.09890711
CF1      0.08731582 0.006252298   0.8994798 0.01570180
CF3      0.20822410 0.393715752   0.2552786 0.20976207
CF2      0.11237742 0.338996251   0.4795570 0.16823990
CF5      0.05805766 0.526853480   0.3595676 0.09876533
CTRL     0.13196682 0.136015253   0.6171474 0.16751309</code></pre>
<pre class="r"><code>estBoth &lt;- reshape2::melt(cellEstBoth$counts)
colnames(estBoth) &lt;- c(&quot;sample&quot;,&quot;cell&quot;,&quot;proportion&quot;)

p2 &lt;- ggplot(estBoth, aes(x = sample, fill = cell)) + 
  geom_bar(aes(weight = proportion)) +
  ggtitle(&quot;Cell type proportion estimates&quot;, 
          subtitle = &quot;Probe selection: Both&quot;) +
  labs(x = &quot;Sample&quot;, y = &quot;Proportion&quot;, fill = &quot;Cell type&quot;) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
        legend.position = &quot;bottom&quot;) +
  scale_fill_manual(values = pal)
p2</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-31-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>fullDat &lt;- rbind(estBoth, estAny)
fullDat$est &lt;- rep(c(&quot;both&quot;,&quot;any&quot;), each = nrow(estAny))

p1 &lt;- ggplot(fullDat, aes(x = sample, y = proportion, fill = est)) + 
  geom_bar(stat = &quot;identity&quot;, position = &quot;dodge&quot;) +
  facet_grid(.~ cell, scales = &quot;free_x&quot;) +
  labs(x = &quot;Sample&quot;, y = &quot;Proportion&quot;, fill = &quot;Source&quot;) +
  theme(axis.text.x = element_text(size = 8, angle = 90, hjust = 1, vjust = 0.5))

p1</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-32-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="compare-to-flow-cytometry-data" class="section level2">
<h2>Compare to flow-cytometry data</h2>
<pre class="r"><code>samps &lt;- targets$Sample_source[targets$Sample_Group == &quot;Raw&quot;]
melt(read.csv(here(&quot;data/Flow-Data-for-Reference-Panel-Scaled.csv&quot;),
              stringsAsFactors = FALSE)) %&gt;%
  mutate(variable = fct_recode(variable, CTRL = &quot;Control&quot;)) %&gt;%
  inner_join(melt(read.csv(here(&quot;data/Flow-Data-for-Reference-Panel-Original.csv&quot;),
                           stringsAsFactors = FALSE)) %&gt;%
  mutate(variable = fct_recode(variable, CTRL = &quot;Control&quot;)), 
             by = c(&quot;X&quot;, &quot;variable&quot;)) %&gt;%
  rename(cell = X, 
         sample = variable, 
         scaled = value.x, 
         original = value.y) %&gt;%
  mutate(scaled = scaled / 100,
         original = original / 100) %&gt;%
  inner_join(estBoth[estBoth$sample %in% samps,] %&gt;%
               rename(both = proportion) %&gt;%
               inner_join(estAny[estBoth$sample %in% samps,] %&gt;%
                            rename(any = proportion))  %&gt;% 
               mutate(cell = gsub(&quot;EpithelialCell&quot;,&quot;AEC&quot;, cell),
                      cell = gsub(&quot;Macrophage&quot;,&quot;macrophages&quot;, cell),
                      cell = gsub(&quot;Granulocyte&quot;,&quot;granulocytes&quot;, cell),
                      cell = gsub(&quot;Lymphocyte&quot;,&quot;lymphocytes&quot;, cell))) %&gt;%
  pivot_longer(cols = c(scaled, original)) -&gt; dat

p1 &lt;- ggplot(dat, aes(x = rowMeans(cbind(value, any)), 
                      y = value - any, colour = cell)) +
  geom_point(aes(shape = name)) +
  geom_hline(yintercept = 0, linetype = &quot;dashed&quot;, colour = &quot;red&quot;) +
  facet_wrap(vars(sample), ncol = 3, nrow = 2) +
  labs(x = &quot;Mean&quot;, y = &quot;Difference (Flow - Meth. est.)&quot;,
       colour = &quot;Cell Type&quot;, shape = &quot;Flow Data&quot;) +
  scale_shape_manual(values = c(1,4)) +
  ggtitle(&quot;Probe selection: Any&quot;)

p2 &lt;- ggplot(dat, aes(x = rowMeans(cbind(value, both)), 
                      y = value - both, colour = cell)) +
  geom_point(aes(shape = name)) +
  geom_hline(yintercept = 0, linetype = &quot;dashed&quot;, colour = &quot;red&quot;) +
  facet_wrap(vars(sample), ncol = 3, nrow = 2) +
  labs(x = &quot;Mean&quot;, y = &quot;Difference (Flow - Meth. est.)&quot;,
       colour = &quot;Cell Type&quot;, shape = &quot;Flow Data&quot;) +
  scale_shape_manual(values = c(1,4)) +
  ggtitle(&quot;Probe selection: Both&quot;)

p1 / p2 + plot_layout(guides = &quot;collect&quot;)</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-33-1.png" width="672" style="display: block; margin: auto;" /></p>
<!-- ```{r, warning=FALSE, message=FALSE, fig.width=8, fig.height=13} -->
<!-- anyfitlm <- vector("list", 6) -->
<!-- i = 1 -->
<!-- for(s in unique(as.character(dat$sample))){ -->
<!--   for(n in unique(dat$name)){ -->
<!--     data <- dat[dat$sample == s & dat$name == n,] -->
<!--     anyfitlm[[i]] <- data.frame(fit = predict(lm(any ~ value, data = data)), -->
<!--                       sample = s, -->
<!--                       name = n, -->
<!--                       cell = dat$cell[dat$sample == s & dat$name == n]) -->
<!--     i = i + 1 -->
<!--   }    -->
<!-- } -->
<!-- anyfitlm <- bind_rows(anyfitlm) -->
<!-- bothfitlm <- vector("list", 6) -->
<!-- i = 1 -->
<!-- for(s in unique(dat$sample)){ -->
<!--   for(n in unique(dat$name)){ -->
<!--     data <- dat[dat$sample == s & dat$name == n,] -->
<!--     bothfitlm[[i]] <- data.frame(fit = predict(lm(both ~ value, data = data)), -->
<!--                       sample = s, -->
<!--                       name = n, -->
<!--                       cell = dat$cell[dat$sample == s & dat$name == n]) -->
<!--     i = i + 1 -->
<!--   }    -->
<!-- } -->
<!-- bothfitlm <- bind_rows(bothfitlm) -->
<!-- fitDat <- inner_join(dat, anyfitlm,  -->
<!--                      by = c("sample","name","cell")) %>% -->
<!--   inner_join(bothfitlm, -->
<!--              by = c("sample","name","cell"), -->
<!--              suffix = c(".any", ".both")) -->
<!-- newPal <- pal[-2] -->
<!-- names(newPal) <- c("granulocytes","lymphocytes","macrophages","AEC") -->
<!-- samps <- as.character(unique(fitDat$sample)) -->
<!-- p1 <- vector("list", length(samps)) -->
<!-- for(i in 1:length(samps)){ -->
<!--   dat1 <- dplyr::filter(fitDat, sample == samps[i] & name == "original") -->
<!--   c1 <- cor.test(dat1$any, dat1$value) -->
<!--   p1[[i]] <- ggplot(dat1, aes(x = value, y = any)) + -->
<!--     geom_point(aes(colour = cell), size = 3) + -->
<!--     geom_line(aes(y = fit.any), colour = "darkgrey", linetype = "dashed") +  -->
<!--     labs(x = "Flow cytometry measure", y = "DNAm estimate", -->
<!--          colour = "Cell type") + -->
<!--     coord_cartesian(ylim = c(0, 1), xlim = c(0, 1)) + -->
<!--     ggtitle(samps[i]) + -->
<!--     scale_color_manual(values = newPal) +  -->
<!--     annotate("text", x = 0, y = 0.9, hjust = 0, size = 2.5, -->
<!--              label = glue::glue("Cor (Pearson) = {round(c1$estimate, 4)} -->
<!--                                p-value = {signif(c1$p.value, 4)}")) + -->
<!--     theme(plot.title = element_text(size = 10), -->
<!--           axis.title = element_text(size = 9), -->
<!--           axis.text = element_text(size = 8)) -->
<!-- } -->
<!-- p2 <- vector("list", length(samps)) -->
<!-- for(i in 1:length(samps)){ -->
<!--   dat1 <- dplyr::filter(fitDat, sample == samps[i] & name == "scaled") -->
<!--   c1 <- cor.test(dat1$any, dat1$value) -->
<!--   p2[[i]] <- ggplot(dat1, aes(x = value, y = any)) + -->
<!--     geom_point(aes(colour = cell), size = 3) + -->
<!--     geom_line(aes(y = fit.any), colour = "darkgrey", linetype = "dashed") +  -->
<!--     labs(x = "Flow cytometry measure", y = "DNAm estimate", -->
<!--          colour = "Cell type") + -->
<!--     coord_cartesian(ylim = c(0, 1), xlim = c(0, 1)) + -->
<!--     ggtitle(samps[i]) + -->
<!--     scale_color_manual(values = newPal) +  -->
<!--     annotate("text", x = 0, y = 0.9, hjust = 0, size = 2.5, -->
<!--              label = glue::glue("Cor (Pearson) = {round(c1$estimate, 4)} -->
<!--                                p-value = {signif(c1$p.value, 4)}")) + -->
<!--     theme(plot.title = element_text(size = 10), -->
<!--           axis.title = element_text(size = 9), -->
<!--           axis.text = element_text(size = 8)) -->
<!-- } -->
<!-- p3 <- vector("list", length(samps)) -->
<!-- for(i in 1:length(samps)){ -->
<!--   dat1 <- dplyr::filter(fitDat, sample == samps[i] & name == "original") -->
<!--   c1 <- cor.test(dat1$both, dat1$value) -->
<!--   p3[[i]] <- ggplot(dat1, aes(x = value, y = both)) + -->
<!--     geom_point(aes(colour = cell), size = 3) + -->
<!--     geom_line(aes(y = fit.both), colour = "darkgrey", linetype = "dashed") +  -->
<!--     labs(x = "Flow cytometry measure", y = "DNAm estimate", -->
<!--          colour = "Cell type") + -->
<!--     coord_cartesian(ylim = c(0, 1), xlim = c(0, 1)) + -->
<!--     ggtitle(samps[i]) + -->
<!--     scale_color_manual(values = newPal) +  -->
<!--     annotate("text", x = 0, y = 0.9, hjust = 0, size = 2.5, -->
<!--              label = glue::glue("Cor (Pearson) = {round(c1$estimate, 4)} -->
<!--                                p-value = {signif(c1$p.value, 4)}")) + -->
<!--     theme(plot.title = element_text(size = 10), -->
<!--           axis.title = element_text(size = 9), -->
<!--           axis.text = element_text(size = 8)) -->
<!-- } -->
<!-- p4 <- vector("list", length(samps)) -->
<!-- for(i in 1:length(samps)){ -->
<!--   dat1 <- dplyr::filter(fitDat, sample == samps[i] & name == "scaled") -->
<!--   c1 <- cor.test(dat1$both, dat1$value) -->
<!--   p4[[i]] <- ggplot(dat1, aes(x = value, y = both)) + -->
<!--     geom_point(aes(colour = cell), size = 3) + -->
<!--     geom_line(aes(y = fit.both), colour = "darkgrey", linetype = "dashed") +  -->
<!--     labs(x = "Flow cytometry measure", y = "DNAm estimate", -->
<!--          colour = "Cell type") + -->
<!--     coord_cartesian(ylim = c(0, 1), xlim = c(0, 1)) + -->
<!--     ggtitle(samps[i]) + -->
<!--     scale_color_manual(values = newPal) +  -->
<!--     annotate("text", x = 0, y = 0.9, hjust = 0, size = 2.5, -->
<!--              label = glue::glue("Cor (Pearson) = {round(c1$estimate, 4)} -->
<!--                                p-value = {signif(c1$p.value, 4)}")) + -->
<!--     theme(plot.title = element_text(size = 10), -->
<!--           axis.title = element_text(size = 9), -->
<!--           axis.text = element_text(size = 8)) -->
<!-- } -->
<!-- a <- wrap_plots(p1, ncol = 3, guides = "collect") + -->
<!--   plot_annotation(title = "Probe selection: Any - Flow data: Original") &  -->
<!--   theme(legend.position = "none", -->
<!--           plot.title = element_text(size = 12)) -->
<!-- b <- wrap_plots(p2, ncol = 3, guides = "collect") + -->
<!--   plot_annotation(title = "Probe selection: Any - Flow data: Scaled") &  -->
<!--   theme(legend.position = "bottom", -->
<!--           plot.title = element_text(size = 12)) -->
<!-- c <- wrap_plots(p3, ncol = 3, guides = "collect") + -->
<!--   plot_annotation(title = "Probe selection: Both - Flow data: Original") &  -->
<!--   theme(legend.position = "none", -->
<!--           plot.title = element_text(size = 12)) -->
<!-- d <- wrap_plots(p4, ncol = 3, guides = "collect") + -->
<!--   plot_annotation(title = "Probe selection: Both - Flow data: Scaled") &  -->
<!--   theme(legend.position = "bottom", -->
<!--           plot.title = element_text(size = 12)) -->
<!-- ab <- (wrap_elements(a) / wrap_elements(b)) +  -->
<!--   plot_layout(guides = "collect") +  -->
<!--   plot_annotation(tag_levels = "A") & -->
<!--     theme(plot.tag = element_text(face = 'bold', size = 16)) -->
<!-- cd <- (wrap_elements(c) / wrap_elements(d)) +  -->
<!--   plot_layout(guides = "collect") +  -->
<!--   plot_annotation(tag_levels = "A") & -->
<!--     theme(plot.tag = element_text(face = 'bold', size = 16)) -->
<!-- ab -->
<!-- cd -->
<!-- ``` -->
<pre class="r"><code>newPal &lt;- pal[-2]
names(newPal) &lt;- c(&quot;granulocytes&quot;,&quot;lymphocytes&quot;,&quot;macrophages&quot;,&quot;AEC&quot;)
samps &lt;- as.character(unique(dat$sample))
p &lt;- vector(&quot;list&quot;, length(samps))

for(i in 1:length(samps)){
  dat1 &lt;- filter(dat, sample == samps[i])
  dat1 %&gt;% filter(name == &quot;original&quot;) %&gt;% 
    mutate(dsq = (value - any)^2) %&gt;% 
    pull(dsq) %&gt;% mean() %&gt;% 
    signif(2) -&gt; omse
  dat1 %&gt;% filter(name == &quot;scaled&quot;) %&gt;% 
    mutate(dsq = (value - any)^2) %&gt;% 
    pull(dsq) %&gt;% mean() %&gt;% 
    signif(2) -&gt; smse
  c1 &lt;- cor.test(dat1$any, dat1$value)
  p[[i]] &lt;- ggplot(dat1, aes(x = rowMeans(cbind(value, any)), 
                         y = value - any, colour = cell)) +
    geom_point(aes(shape = name)) +
    scale_color_manual(values = newPal) +
    scale_shape_manual(values = c(1,4)) +
    geom_hline(yintercept = 0, linetype = &quot;dashed&quot;, colour = &quot;red&quot;) +
    labs(x = &quot;Mean&quot;, y = &quot;Difference (Flow - Meth. est.)&quot;,
         colour = &quot;Cell type&quot;, shape = &quot;Measure&quot;) +
    coord_cartesian(ylim = c(-0.5, 0.5), xlim = c(0, 1)) +
    ggtitle({samps[i]}) +
    theme_cowplot(font_size = 10) +
    annotate(&quot;text&quot;, x = 0, y = 0.40, hjust = 0, size = 2.5,
             label = glue::glue(&quot;MSE (original) = {omse}
                               MSE (scaled) = {smse}&quot;))
             #label = glue::glue(&quot;Pearson correlation = {round(c1$estimate, 4)}
              #                 p-value = {signif(c1$p.value, 4)}&quot;))
  
}

p1 &lt;- wrap_plots(p, ncol = 3, guides = &quot;collect&quot;) +
  plot_annotation(title = &quot;Probe select = &#39;Any&#39;&quot;) &amp; 
  theme(legend.position = &quot;none&quot;)

for(i in 1:length(samps)){
  dat1 &lt;- filter(dat, sample == samps[i])
   dat1 %&gt;% filter(name == &quot;original&quot;) %&gt;% 
    mutate(dsq = (value - both)^2) %&gt;% 
    pull(dsq) %&gt;% mean() %&gt;% 
    signif(2) -&gt; omse
  dat1 %&gt;% filter(name == &quot;scaled&quot;) %&gt;% 
    mutate(dsq = (value - both)^2) %&gt;% 
    pull(dsq) %&gt;% mean() %&gt;% 
    signif(2) -&gt; smse
  c1 &lt;- cor.test(dat1$both, dat1$value)
  p[[i]] &lt;- ggplot(dat1, aes(x = rowMeans(cbind(value, both)), 
                         y = value - both, colour = cell)) +
    geom_point(aes(shape = name)) +
    scale_shape_manual(values = c(1,4)) +
    scale_color_manual(values = newPal) +
    geom_hline(yintercept = 0, linetype = &quot;dashed&quot;, colour = &quot;red&quot;) +
    labs(x = &quot;Mean&quot;, y = &quot;Difference (Flow - Meth. est.)&quot;,
         colour = &quot;Cell type&quot;, shape = &quot;Measure&quot;) +
    coord_cartesian(ylim = c(-0.5, 0.5), xlim = c(0, 1)) +
    ggtitle(samps[i]) +
    theme_cowplot(font_size = 10) +
    annotate(&quot;text&quot;, x = 0, y = 0.40, hjust = 0, size = 2.5,
             label = glue::glue(&quot;MSE (original) = {omse}
                               MSE (scaled) = {smse}&quot;))
             #label = glue::glue(&quot;Pearson correlation = {round(c1$estimate, 4)}
              #                 p-value = {signif(c1$p.value, 4)}&quot;))
  
}

p2 &lt;- wrap_plots(p, ncol = 3, guides = &quot;collect&quot;) +
  plot_annotation(title = &quot;Probe select = &#39;Both&#39;&quot;) &amp; 
  theme(legend.position = &quot;bottom&quot;, legend.box = &quot;vertical&quot;)

(wrap_elements(p1) / wrap_elements(p2)) + 
  plot_layout(guides = &quot;collect&quot;) + 
  plot_annotation(tag_levels = &quot;A&quot;) &amp;
    theme(plot.tag = element_text(face = &#39;bold&#39;, size = 16))</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-34-1.png" width="768" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="figure-5" class="section level1">
<h1><strong>Figure 5</strong></h1>
<pre class="r"><code>dat %&gt;% select(cell, sample, value, name) %&gt;%
  bind_rows(dat %&gt;% select(cell, sample, both) %&gt;% 
              rename(value = both) %&gt;%
              mutate(name = &quot;both&quot;)) %&gt;%
  bind_rows(dat %&gt;% select(cell, sample, any) %&gt;% 
              rename(value = any) %&gt;%
              mutate(name = &quot;any&quot;)) -&gt; longDat

p1a &lt;- ggplot(longDat, aes(x = sample, y = value, fill = name)) + 
  geom_bar(stat = &quot;identity&quot;, position = &quot;dodge&quot;) +
  facet_grid(.~ cell, scales = &quot;free_x&quot;) +
  labs(x = &quot;Cell type&quot;, y = &quot;Proportion&quot;, fill = &quot;Source&quot;) + 
  theme_cowplot() 

((p1a + scale_fill_brewer(palette = &quot;Set2&quot;) + 
    theme(legend.position = &quot;bottom&quot;,
              legend.text = element_text(size = 8),
              legend.title = element_text(size = 9),
          axis.text = element_text(size = 8),
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
          axis.title = element_text(size = 10))) / 
   wrap_elements(p1) / wrap_elements(p2)) + 
  plot_layout(heights = c(1,2,2)) +
  plot_annotation(tag_levels = &quot;A&quot;) &amp;
    theme(plot.tag = element_text(face = &#39;bold&#39;, size = 16))</code></pre>
<p><img src="figure/estimateCellProportions.Rmd/unnamed-chunk-35-1.png" width="672" style="display: block; margin: auto;" /></p>
<br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span> Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 4.0.2 (2020-06-22)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: CentOS Linux 7 (Core)

Matrix products: default
BLAS:   /config/binaries/R/4.0.2/lib64/R/lib/libRblas.so
LAPACK: /config/binaries/R/4.0.2/lib64/R/lib/libRlapack.so

locale:
 [1] LC_CTYPE=en_AU.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_AU.UTF-8        LC_COLLATE=en_AU.UTF-8    
 [5] LC_MONETARY=en_AU.UTF-8    LC_MESSAGES=en_AU.UTF-8   
 [7] LC_PAPER=en_AU.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_AU.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats4    parallel  stats     graphics  grDevices utils     datasets 
[8] methods   base     

other attached packages:
 [1] RColorBrewer_1.1-2                                 
 [2] cowplot_1.1.1                                      
 [3] missMethyl_1.24.0                                  
 [4] IlluminaHumanMethylation450kanno.ilmn12.hg19_0.6.0 
 [5] patchwork_1.1.1                                    
 [6] forcats_0.5.1                                      
 [7] stringr_1.4.0                                      
 [8] dplyr_1.0.4                                        
 [9] purrr_0.3.4                                        
[10] readr_1.4.0                                        
[11] tidyr_1.1.2                                        
[12] tibble_3.1.2                                       
[13] tidyverse_1.3.0                                    
[14] reshape2_1.4.4                                     
[15] ggplot2_3.3.5                                      
[16] FlowSorted.Blood.EPIC_1.8.0                        
[17] ExperimentHub_1.16.0                               
[18] AnnotationHub_2.22.0                               
[19] BiocFileCache_1.14.0                               
[20] dbplyr_2.1.0                                       
[21] nlme_3.1-152                                       
[22] quadprog_1.5-8                                     
[23] genefilter_1.72.1                                  
[24] IlluminaHumanMethylationEPICmanifest_0.3.0         
[25] IlluminaHumanMethylationEPICanno.ilm10b4.hg19_0.6.0
[26] minfi_1.36.0                                       
[27] bumphunter_1.32.0                                  
[28] locfit_1.5-9.4                                     
[29] iterators_1.0.13                                   
[30] foreach_1.5.1                                      
[31] Biostrings_2.58.0                                  
[32] XVector_0.30.0                                     
[33] SummarizedExperiment_1.20.0                        
[34] Biobase_2.50.0                                     
[35] MatrixGenerics_1.2.1                               
[36] matrixStats_0.59.0                                 
[37] GenomicRanges_1.42.0                               
[38] GenomeInfoDb_1.26.7                                
[39] IRanges_2.24.1                                     
[40] S4Vectors_0.28.1                                   
[41] BiocGenerics_0.36.1                                
[42] limma_3.46.0                                       
[43] glue_1.4.2                                         
[44] here_1.0.1                                         
[45] workflowr_1.6.2                                    

loaded via a namespace (and not attached):
  [1] utf8_1.2.1                    tidyselect_1.1.0             
  [3] RSQLite_2.2.5                 AnnotationDbi_1.52.0         
  [5] grid_4.0.2                    BiocParallel_1.24.1          
  [7] munsell_0.5.0                 codetools_0.2-18             
  [9] preprocessCore_1.52.1         statmod_1.4.35               
 [11] withr_2.4.2                   colorspace_2.0-2             
 [13] highr_0.8                     knitr_1.31                   
 [15] rstudioapi_0.13               NMF_0.23.0                   
 [17] labeling_0.4.2                git2r_0.28.0                 
 [19] GenomeInfoDbData_1.2.4        bit64_4.0.5                  
 [21] farver_2.1.0                  rhdf5_2.34.0                 
 [23] rprojroot_2.0.2               vctrs_0.3.8                  
 [25] generics_0.1.0                xfun_0.23                    
 [27] R6_2.5.0                      doParallel_1.0.16            
 [29] illuminaio_0.32.0             bitops_1.0-7                 
 [31] rhdf5filters_1.2.0            cachem_1.0.4                 
 [33] reshape_0.8.8                 DelayedArray_0.16.3          
 [35] assertthat_0.2.1              promises_1.2.0.1             
 [37] scales_1.1.1                  gtable_0.3.0                 
 [39] rlang_0.4.11                  splines_4.0.2                
 [41] rtracklayer_1.50.0            GEOquery_2.58.0              
 [43] broom_0.7.4                   BiocManager_1.30.10          
 [45] yaml_2.2.1                    modelr_0.1.8                 
 [47] GenomicFeatures_1.42.1        backports_1.2.1              
 [49] httpuv_1.5.5                  tools_4.0.2                  
 [51] gridBase_0.4-7                nor1mix_1.3-0                
 [53] ellipsis_0.3.2                siggenes_1.64.0              
 [55] Rcpp_1.0.6                    plyr_1.8.6                   
 [57] sparseMatrixStats_1.2.0       progress_1.2.2               
 [59] zlibbioc_1.36.0               RCurl_1.98-1.3               
 [61] prettyunits_1.1.1             openssl_1.4.3                
 [63] haven_2.3.1                   cluster_2.1.0                
 [65] fs_1.5.0                      magrittr_2.0.1               
 [67] data.table_1.13.6             reprex_1.0.0                 
 [69] whisker_0.4                   hms_1.0.0                    
 [71] mime_0.10                     evaluate_0.14                
 [73] xtable_1.8-4                  XML_3.99-0.5                 
 [75] mclust_5.4.7                  readxl_1.3.1                 
 [77] compiler_4.0.2                biomaRt_2.46.3               
 [79] crayon_1.4.1                  htmltools_0.5.1.1            
 [81] later_1.1.0.1                 lubridate_1.7.9.2            
 [83] DBI_1.1.1                     MASS_7.3-53.1                
 [85] rappdirs_0.3.3                Matrix_1.3-2                 
 [87] cli_3.0.0                     pkgconfig_2.0.3              
 [89] registry_0.5-1                GenomicAlignments_1.26.0     
 [91] xml2_1.3.2                    annotate_1.68.0              
 [93] rngtools_1.5                  pkgmaker_0.32.2              
 [95] multtest_2.46.0               beanplot_1.2                 
 [97] rvest_0.3.6                   doRNG_1.8.2                  
 [99] scrime_1.3.5                  digest_0.6.27                
[101] rmarkdown_2.6                 base64_2.0                   
[103] cellranger_1.1.0              DelayedMatrixStats_1.12.3    
[105] curl_4.3                      shiny_1.6.0                  
[107] Rsamtools_2.6.0               lifecycle_1.0.0              
[109] jsonlite_1.7.2                Rhdf5lib_1.12.1              
[111] askpass_1.1                   fansi_0.5.0                  
[113] pillar_1.6.1                  lattice_0.20-41              
[115] fastmap_1.1.0                 httr_1.4.2                   
[117] survival_3.2-7                interactiveDisplayBase_1.28.0
[119] BiocVersion_3.12.0            bit_4.0.4                    
[121] stringi_1.5.3                 HDF5Array_1.18.1             
[123] blob_1.2.1                    org.Hs.eg.db_3.12.0          
[125] memoise_2.0.0.9000           </code></pre>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>




</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
